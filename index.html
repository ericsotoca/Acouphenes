<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acouph√®nes Zen - Gestion & Auto-hypnose</title>
    <style>
        /* --- CSS Int√©gr√© --- */

        /* Variables (Th√®me Clair par d√©faut) */
        :root {
            --bg-color: #f4f7f9;
            --text-color: #333;
            --primary-color: #4a90e2; /* Bleu doux */
            --secondary-color: #7cb342; /* Vert apaisant */
            --accent-color: #f7b731; /* Jaune doux */
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --input-bg: #ffffff;
            --button-text: #ffffff;
            --link-color: #4a90e2;
            --disabled-color: #cccccc;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #e74c3c; /* Rouge pour suppression */

            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.6;

            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;

            --border-radius: 4px;
            --shadow: 0 2px 5px var(--shadow-color);
        }

        /* Th√®me Sombre */
        body.dark-mode {
            --bg-color: #2c3e50; /* Bleu nuit */
            --text-color: #ecf0f1; /* Blanc cass√© */
            --primary-color: #5dade2; /* Bleu plus clair */
            --secondary-color: #82e0aa; /* Vert plus clair */
            --accent-color: #f4d03f; /* Jaune plus clair */
            --card-bg: #34495e; /* Bleu gris fonc√© */
            --border-color: #4b6584; /* Gris bleu */
            --input-bg: #4b6584;
            --button-text: #2c3e50; /* Texte sombre pour boutons clairs */
            --link-color: #5dade2;
            --disabled-color: #7f8c8d; /* Gris sombre */
            --shadow-color: rgba(0, 0, 0, 0.3);
            --danger-color: #f1948a; /* Rouge plus clair */
        }

        /* Reset et Styles Globaux */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: var(--font-size-base);
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: var(--line-height-base);
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-top: 70px; /* Espace pour la nav fixe (un peu plus) */
        }

        #app {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--spacing-l);
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            padding: var(--spacing-s) var(--spacing-l);
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
         nav .nav-brand {
            font-weight: bold;
            font-size: 1.3em;
            color: var(--primary-color);
            text-decoration: none;
            margin-right: var(--spacing-l);
         }

        nav ul {
            list-style: none;
            display: flex;
            gap: var(--spacing-m);
            flex-wrap: wrap;
             align-items: center;
        }

        nav a {
            text-decoration: none;
            color: var(--link-color);
            font-weight: 500;
            transition: color 0.2s ease, background-color 0.2s ease;
            padding: var(--spacing-s) var(--spacing-m);
            border-radius: var(--border-radius);
        }

        nav a:hover,
        nav a.active {
            color: var(--primary-color);
            background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }

        /* Contenu Principal */
        main {
            padding-top: var(--spacing-m);
            min-height: calc(100vh - 140px); /* Hauteur minimale pour pousser le footer */
        }

        .content-section {
            background-color: var(--card-bg);
            padding: var(--spacing-l);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: var(--spacing-l);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* √âl√©ments de Formulaire */
        fieldset {
            border: 1px solid var(--border-color);
            padding: var(--spacing-m);
            border-radius: var(--border-radius);
        }
        legend {
            font-weight: 600;
            padding: 0 var(--spacing-s);
            color: var(--primary-color);
        }
        label {
            display: block;
            margin-bottom: var(--spacing-s);
            font-weight: 500;
        }
         /* Style pour les groupes de radio boutons */
        .radio-group label {
            display: inline-block; /* Pour les mettre c√¥te √† c√¥te avec l'input */
            margin-right: var(--spacing-m);
            font-weight: normal;
        }
        .radio-group input[type="radio"] {
            margin-right: var(--spacing-xs);
            vertical-align: middle; /* Aligner avec le texte */
        }


        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: var(--spacing-s) var(--spacing-m);
            margin-bottom: var(--spacing-m);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

         /* Style pour les sliders */
        input[type="range"] {
            width: calc(100% - 50px); /* Laisser de la place pour l'output */
            vertical-align: middle;
             cursor: pointer;
        }
        output {
            display: inline-block;
            min-width: 30px;
            text-align: right;
            font-weight: bold;
            color: var(--primary-color);
            vertical-align: middle;
            margin-left: var(--spacing-s);
        }

        button,
        .button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--button-text);
            border: none;
            padding: var(--spacing-m) var(--spacing-l);
            border-radius: var(--border-radius);
            font-size: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            text-decoration: none;
        }

        button:hover,
        .button:hover {
            background-color: color-mix(in srgb, var(--primary-color) 90%, black);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        button:disabled,
        .button:disabled {
            background-color: var(--disabled-color);
            color: color-mix(in srgb, var(--text-color) 50%, var(--disabled-color));
            cursor: not-allowed;
            box-shadow: none;
        }

        .button-secondary {
            background-color: var(--secondary-color);
        }
         .button-secondary:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 90%, black);
        }
        .button-danger {
            background-color: var(--danger-color);
        }
         .button-danger:hover {
            background-color: color-mix(in srgb, var(--danger-color) 80%, black);
         }

        /* Utilitaires */
        .hidden { display: none !important; } /* Important pour forcer */
        .text-center { text-align: center; }
        .mt-s { margin-top: var(--spacing-s); }
        .mt-m { margin-top: var(--spacing-m); }
        .mt-l { margin-top: var(--spacing-l); }
        .mb-m { margin-bottom: var(--spacing-m); }
        .mb-l { margin-bottom: var(--spacing-l); }
         .alert {
             padding: var(--spacing-m);
             margin-bottom: var(--spacing-m);
             border-radius: var(--border-radius);
             border: 1px solid transparent;
         }
         .alert-info {
             color: #0c5460;
             background-color: #d1ecf1;
             border-color: #bee5eb;
         }
         .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
         }
         .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
         }
         .alert-danger {
             color: #721c24;
             background-color: #f8d7da;
             border-color: #f5c6cb;
         }


        /* Styles sp√©cifiques aux modules */
        #hypnose-session .timer {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: var(--spacing-l) 0;
            color: var(--secondary-color);
             font-variant-numeric: tabular-nums; /* Pour √©viter le d√©calage des chiffres */
        }
        #hypnose-session .session-text {
            background-color: color-mix(in srgb, var(--bg-color) 95%, var(--text-color));
            padding: var(--spacing-m) var(--spacing-l);
            border-radius: var(--border-radius);
            min-height: 180px;
            border-left: 5px solid var(--primary-color);
            font-size: 1.1em;
            line-height: 1.7;
            overflow-y: auto; /* Scroll si le texte est long */
            max-height: 300px;
        }
        #hypnose-session .controls label { display: inline-block; margin-right: var(--spacing-s);}
        #hypnose-session .controls input[type="range"] { width: 100px; vertical-align: middle; }
        #hypnose-session .controls select { width: auto; display: inline-block; margin-right: var(--spacing-m); }

        /* Suivi */
        #tracking-history ul {
            list-style: none;
            padding-left: 0;
             max-height: 400px; /* Limiter la hauteur de l'historique */
             overflow-y: auto; /* Ajouter un scroll si n√©cessaire */
             border: 1px solid var(--border-color);
             padding: var(--spacing-m);
             border-radius: var(--border-radius);
        }
        #tracking-history li {
            border-bottom: 1px dashed var(--border-color);
            padding: var(--spacing-m) 0;
            margin-bottom: var(--spacing-s);
        }
         #tracking-history li:last-child {
            border-bottom: none;
            margin-bottom: 0;
         }
         #tracking-history strong { color: var(--primary-color); }
         #tracking-history em { color: color-mix(in srgb, var(--text-color) 70%, var(--bg-color));}

         /* Graphique SVG */
        #tracking-chart-container {
            margin-top: var(--spacing-l);
             min-height: 250px;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             padding: var(--spacing-m);
             position: relative; /* Pour positionner le message "pas de donn√©es" */
        }
         #tracking-chart-container svg {
             display: block;
             width: 100%;
             height: 100%;
             min-height: 220px;
         }
         .chart-line {
            fill: none;
            stroke: var(--secondary-color);
            stroke-width: 2px;
         }
         .chart-point {
            fill: var(--primary-color);
            stroke: var(--card-bg); /* Pour d√©tacher du fond */
            stroke-width: 1px;
         }
         .chart-axis {
            stroke: var(--border-color);
            stroke-width: 1px;
         }
         .chart-text {
            font-size: 10px;
            fill: var(--text-color);
            text-anchor: middle;
         }
         .chart-text.axis-label-y { text-anchor: end; }
         .chart-text.axis-label-x { text-anchor: middle; }
         .chart-no-data {
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             color: var(--disabled-color);
             font-style: italic;
         }

         /* Footer */
         footer {
             text-align: center;
             padding: var(--spacing-m);
             margin-top: var(--spacing-l);
             font-size: 0.9em;
             color: color-mix(in srgb, var(--text-color) 60%, var(--bg-color));
             border-top: 1px solid var(--border-color);
         }


        /* Responsive */
        @media (max-width: 768px) {
            nav {
                padding: var(--spacing-s) var(--spacing-m);
                justify-content: center; /* Centrer tout sur petit √©cran */
            }
            nav .nav-brand { margin-bottom: var(--spacing-s); width: 100%; text-align: center; }
            nav ul {
                 gap: var(--spacing-s);
                 justify-content: center; /* Centrer les liens sur petit √©cran */
                 width: 100%; /* Prendre toute la largeur */
                 margin-top: var(--spacing-s);
            }
            #app {
                 padding: var(--spacing-m);
            }
            .content-section {
                 padding: var(--spacing-m);
            }
            button, .button {
                /* Pleine largeur sur mobile pour faciliter le clic */
                /* width: 100%; */
                /* margin-bottom: var(--spacing-s); */
                 padding: var(--spacing-m); /* Un peu moins de padding */
            }
             input[type="range"] { width: calc(100% - 40px); } /* Ajuster pour output */
             output { min-width: 25px; }
             #hypnose-session .timer { font-size: 2em; }
        }

        /* Theme Toggle */
        #theme-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.6em; /* Rendre l'ic√¥ne plus grande */
            padding: 0 var(--spacing-s);
            color: var(--text-color);
             margin-left: auto; /* Pousse le bouton vers la droite */
        }
        @media (max-width: 768px) {
            #theme-toggle { margin-left: 0; } /* Pas de push √† droite sur mobile */
        }


    </style>
</head>
<body>
    <div id="app">
        <nav id="main-nav">
             <a href="#home" class="nav-brand">Acouph√®nes Zen</a>
            <ul>
                <li><a href="#home">Accueil</a></li>
                <li><a href="#evaluation">√âvaluation</a></li>
                <li><a href="#hypnose">Auto-Hypnose</a></li>
                <li><a href="#sounds">Sons</a></li>
                <li><a href="#tracking">Suivi</a></li>
                <li><a href="#resources">Ressources</a></li>
            </ul>
             <button id="theme-toggle" title="Changer le th√®me">‚òÄÔ∏è</button>
        </nav>

        <main id="main-content">
            <!-- Le contenu des templates sera inject√© ici -->
        </main>

        <footer>
            <p>Acouph√®nes Zen &copy; 2024 - Outil de gestion non m√©dical.</p>
            <p style="font-size: 0.8em; margin-top: 5px;"><strong>Important:</strong> Cette application ne remplace pas un avis m√©dical. Consultez un professionnel de sant√©.</p>
        </footer>
    </div>

    <!-- --- Mod√®les HTML --- -->

    <template id="template-home">
        <section class="content-section">
            <h1>Bienvenue sur Acouph√®nes Zen</h1>
            <p class="lead" style="font-size: 1.1em;">Votre compagnon pour mieux comprendre et g√©rer vos acouph√®nes au quotidien gr√¢ce √† l'auto-hypnose et aux sons th√©rapeutiques.</p>

            <div class="alert alert-warning mt-l mb-l">
                <strong>Avertissement Important :</strong> Acouph√®nes Zen est un outil d'accompagnement et de gestion. Il n'est pas destin√© √† diagnostiquer, traiter ou gu√©rir les acouph√®nes. Consultez <strong>toujours</strong> un m√©decin ou un sp√©cialiste ORL pour un diagnostic pr√©cis et un plan de traitement adapt√© √† votre situation.
            </div>

            <h2 class="mt-l">Comment cette application peut vous aider :</h2>
            <ul>
                <li><strong>Comprendre :</strong> Acc√©dez √† des informations claires sur les acouph√®nes et l'approche par l'auto-hypnose (<a href="#resources">Ressources</a>).</li>
                <li><strong>√âvaluer :</strong> Faites une premi√®re √©valuation de vos acouph√®nes et de leur impact (<a href="#evaluation">√âvaluation</a>).</li>
                <li><strong>Apaiser :</strong> Utilisez des sessions guid√©es d'auto-hypnose con√ßues pour la relaxation et la gestion de la perception des acouph√®nes (<a href="#hypnose">Auto-Hypnose</a>).</li>
                <li><strong>Masquer :</strong> G√©n√©rez des sons th√©rapeutiques (bruit blanc, rose, brun) pour potentiellement r√©duire la g√™ne occasionn√©e par les acouph√®nes (<a href="#sounds">Sons</a>).</li>
                <li><strong>Suivre :</strong> Tenez un journal de l'intensit√© de vos acouph√®nes et visualisez votre progression (<a href="#tracking">Suivi</a>).</li>
            </ul>

            <h2 class="mt-l">Pour commencer :</h2>
            <p>Nous vous recommandons de commencer par la section <a href="#evaluation">√âvaluation</a> pour mieux cerner votre situation. Ensuite, explorez les sessions d'<a href="#hypnose">Auto-Hypnose</a> ou le <a href="#sounds">G√©n√©rateur de Sons</a>.</p>

            <p class="mt-m" style="font-style: italic;">Toutes vos donn√©es sont stock√©es <strong>uniquement sur votre appareil</strong> (dans le stockage local de votre navigateur) et ne sont jamais envoy√©es sur un serveur.</p>

            <div class="text-center mt-l">
                <a href="#evaluation" class="button">Commencer l'√©valuation</a>
            </div>
        </section>
    </template>

    <template id="template-evaluation">
        <section class="content-section">
            <h2>√âvaluation Initiale des Acouph√®nes</h2>
            <form id="evaluation-form">
                <p>Ce questionnaire aide √† mieux comprendre vos acouph√®nes et leur impact. Vos r√©ponses sont confidentielles et stock√©es localement.</p>

                <fieldset class="mb-l">
                    <legend class="mb-m">Caract√©ristiques des acouph√®nes</legend>
                    <label for="sound-type">Quel type de son entendez-vous principalement ? (Ex: Sifflement aigu, bourdonnement grave, pulsation, cliquetis...)</label>
                    <input type="text" id="sound-type" name="sound-type" required placeholder="D√©crivez le son principal">

                    <label class="mt-m">Le son est-il per√ßu dans :</label>
                    <div class="radio-group">
                        <input type="radio" id="ear-left" name="ear-location" value="left"> <label for="ear-left">Oreille gauche</label>
                        <input type="radio" id="ear-right" name="ear-location" value="right"> <label for="ear-right">Oreille droite</label>
                        <input type="radio" id="ear-both" name="ear-location" value="both" checked> <label for="ear-both">Les deux oreilles</label>
                        <input type="radio" id="ear-head" name="ear-location" value="head"> <label for="ear-head">Dans la t√™te</label>
                    </div>

                    <label for="intensity-avg" class="mt-m">Sur une √©chelle de 0 (pas d'acouph√®ne audible) √† 10 (insupportablement fort), quelle est l'intensit√© <strong>moyenne</strong> de vos acouph√®nes quand vous y pr√™tez attention ?</label>
                    <input type="range" id="intensity-avg" name="intensity-avg" min="0" max="10" value="5" step="1" oninput="this.nextElementSibling.textContent = this.value"> <output>5</output>

                    <label for="variation" class="mt-m">L'intensit√© de vos acouph√®nes varie-t-elle beaucoup au cours de la journ√©e ou des jours ?</label>
                    <select id="variation" name="variation">
                        <option value="peu">Peu ou pas</option>
                        <option value="moderee">Mod√©r√©ment</option>
                        <option value="beaucoup">Beaucoup</option>
                    </select>
                </fieldset>

                 <fieldset class="mb-l">
                     <legend class="mb-m">Impact sur votre quotidien</legend>
                     <label for="impact-sleep">Sur une √©chelle de 0 (aucun impact) √† 10 (impact majeur), √† quel point vos acouph√®nes affectent-ils votre <strong>sommeil</strong> (endormissement, r√©veils) ?</label>
                    <input type="range" id="impact-sleep" name="impact-sleep" min="0" max="10" value="3" step="1" oninput="this.nextElementSibling.textContent = this.value"> <output>3</output>

                     <label for="impact-concentration" class="mt-m">√Ä quel point affectent-ils votre capacit√© de <strong>concentration</strong> ou votre attention (travail, lecture...) ? (0=aucun, 10=majeur)</label>
                    <input type="range" id="impact-concentration" name="impact-concentration" min="0" max="10" value="3" step="1" oninput="this.nextElementSibling.textContent = this.value"> <output>3</output>

                    <label for="impact-mood" class="mt-m">√Ä quel point affectent-ils votre <strong>humeur</strong> (stress, anxi√©t√©, irritabilit√©, moral) ? (0=aucun, 10=majeur)</label>
                    <input type="range" id="impact-mood" name="impact-mood" min="0" max="10" value="3" step="1" oninput="this.nextElementSibling.textContent = this.value"> <output>3</output>

                     <label for="impact-hearing" class="mt-m">√Ä quel point pensez-vous que vos acouph√®nes interf√®rent avec votre capacit√© √† <strong>entendre</strong> les sons ext√©rieurs ? (0=aucun, 10=majeur)</label>
                    <input type="range" id="impact-hearing" name="impact-hearing" min="0" max="10" value="2" step="1" oninput="this.nextElementSibling.textContent = this.value"> <output>2</output>
                 </fieldset>

                 <fieldset>
                    <legend class="mb-m">Facteurs d'influence (Optionnel)</legend>
                    <label for="triggers">Y a-t-il des facteurs qui semblent <strong>aggraver</strong> vos acouph√®nes ? (Ex: Stress, fatigue, bruit fort, silence, caf√©ine, alcool, certains aliments, posture...)</label>
                    <textarea id="triggers" name="triggers" rows="3" placeholder="Notez ici ce qui semble augmenter vos acouph√®nes"></textarea>

                     <label for="reducers" class="mt-m">Y a-t-il des facteurs qui semblent les <strong>att√©nuer</strong> ou vous aider √† mieux les g√©rer ? (Ex: Bruit de fond, musique douce, relaxation, activit√© physique, concentration sur une t√¢che...)</label>
                    <textarea id="reducers" name="reducers" rows="3" placeholder="Notez ici ce qui semble vous aider"></textarea>
                 </fieldset>

                <div id="evaluation-result" class="mt-l mb-m"></div>

                <button type="submit" class="mt-m">Enregistrer ou Mettre √† jour l'√©valuation</button>
            </form>
        </section>
    </template>

    <template id="template-hypnose">
        <section class="content-section">
            <h2>Auto-Hypnose Guid√©e</h2>
            <p>Choisissez une session ci-dessous. Installez-vous confortablement dans un endroit calme o√π vous ne serez pas d√©rang√© pendant la dur√©e indiqu√©e. Utilisez des √©couteurs si possible pour une meilleure immersion, surtout si vous utilisez un bruit de fond.</p>
             <div class="alert alert-info mt-m">
                <strong>Conseil :</strong> L'auto-hypnose est une comp√©tence qui s'am√©liore avec la pratique. Soyez patient avec vous-m√™me. L'objectif n'est pas de "faire dispara√Ætre" l'acouph√®ne pendant la session, mais plut√¥t d'apprendre √† modifier votre relation avec lui et √† induire un √©tat de relaxation profonde.
             </div>

            <div id="hypnose-menu" class="mt-l">
                <h3 class="mb-m">S√©lectionnez une session :</h3>
                <button class="button mb-m" data-session="debutant">D√©butant (env. 10 min) - Relaxation et Prise de Conscience</button>
                <button class="button mb-m" data-session="intermediaire">Interm√©diaire (env. 15 min) - D√©tournement de l'Attention</button>
                <button class="button mb-m" data-session="avance">Avanc√© (env. 20 min) - Modification de la Perception</button>
            </div>

            <div id="hypnose-session" class="hidden mt-l">
                <h3 id="session-title" class="mb-m"></h3>
                <div class="timer">--:--</div>
                <p id="session-step-indicator" class="text-center" style="font-style: italic; margin-bottom: var(--spacing-m);"></p>
                <div class="session-text" id="session-text-content">
                    <p>Chargement de la session...</p>
                </div>
                <div class="controls mt-l text-center">
                    <label for="hypno-noise">Bruit de fond :</label>
                    <select id="hypno-noise">
                        <option value="none">Aucun</option>
                        <option value="white">Bruit Blanc</option>
                        <option value="pink">Bruit Rose</option>
                        <option value="brown">Bruit Brun</option>
                    </select>
                    <label for="hypno-volume">Volume:</label>
                    <input type="range" id="hypno-volume" min="0" max="0.5" step="0.01" value="0.05"> <!-- Volume max limit√© pour s√©curit√© -->

                    <div class="mt-l">
                        <button id="start-session-btn" class="button-secondary">D√©marrer la session</button>
                        <button id="stop-session-btn" class="button-danger hidden">Arr√™ter la session</button>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <template id="template-sounds">
        <section class="content-section">
            <h2>G√©n√©rateur de Sons Th√©rapeutiques</h2>
            <p>Utilisez ces sons pour cr√©er un environnement sonore plus confortable. Ils peuvent aider √† masquer l'acouph√®ne ou √† d√©tourner votre attention.</p>
             <div class="alert alert-info mt-m">
                <strong>Conseil :</strong> Exp√©rimentez avec diff√©rents types de sons et volumes. L'objectif n'est pas de couvrir compl√®tement l'acouph√®ne, mais de trouver un niveau o√π il devient moins perceptible ou moins g√™nant. Un volume juste en dessous ou au niveau de votre acouph√®ne est souvent recommand√© (th√©rapie par le bruit / TRT).
             </div>

            <div class="sound-generator-controls mt-l">
                 <div class="mb-m">
                    <label for="sound-type-select">Type de son :</label>
                     <select id="sound-type-select">
                         <option value="white">Bruit Blanc</option>
                         <option value="pink">Bruit Rose</option>
                         <option value="brown">Bruit Brun</option>
                         <!-- <option value="rain" disabled>Pluie (Bient√¥t)</option> -->
                     </select>
                 </div>

                <div class="mb-m">
                    <label for="sound-volume">Volume :</label>
                    <input type="range" id="sound-volume" min="0" max="0.7" step="0.01" value="0.1"> <output>0.10</output>
                </div>

                <!-- Option Minuteur d'arr√™t -->
                 <div class="mb-l">
                    <label for="sound-timer">Minuteur d'arr√™t (minutes, 0 = infini) :</label>
                    <input type="number" id="sound-timer" min="0" step="5" value="0" style="width: 100px; display: inline-block;">
                     <span id="sound-timer-status" style="margin-left: var(--spacing-s);"></span>
                 </div>

                <div class="mt-l">
                    <button id="play-sound-btn" class="button">‚ñ∂Ô∏è Jouer</button>
                    <button id="stop-sound-btn" class="button-danger hidden">‚èπÔ∏è Arr√™ter</button>
                </div>

            </div>
        </section>
    </template>

    <template id="template-tracking">
        <section class="content-section">
            <h2>Suivi Quotidien de vos Acouph√®nes</h2>
            <p>Noter r√©guli√®rement l'intensit√© de vos acouph√®nes et les facteurs associ√©s peut vous aider √† identifier des tendances et √† mieux comprendre ce qui influence votre perception.</p>

            <form id="tracking-form" class="mb-l">
                 <legend class="mb-m">Ajouter une entr√©e au journal</legend>
                 <div class="alert alert-info mb-m">Date et heure actuelles seront enregistr√©es automatiquement.</div>
                <label for="tracking-intensity">Sur une √©chelle de 0 (pas d'acouph√®ne audible) √† 10 (insupportablement fort), comment √©valuez-vous l'intensit√© de vos acouph√®nes <strong>en ce moment</strong> ?</label>
                <input type="range" id="tracking-intensity" name="intensity" min="0" max="10" value="5" step="1" required oninput="this.nextElementSibling.textContent = this.value"> <output>5</output>

                <label for="tracking-notes" class="mt-m">Notes (optionnel) : Qu'avez-vous remarqu√© aujourd'hui ? (Ex: Niveau de stress, fatigue, activit√©s, sessions effectu√©es, humeur, environnement sonore...)</label>
                <textarea id="tracking-notes" name="notes" rows="4" placeholder="Ex: Journ√©e stressante, acouph√®nes plus forts. Session de relaxation aid√© un peu."></textarea>

                <button type="submit" class="mt-m">Ajouter au journal</button>
            </form>

            <hr style="margin: var(--spacing-l) 0; border: none; border-top: 1px solid var(--border-color);">

            <div id="tracking-history" class="mb-l">
                <h3>Historique des Entr√©es</h3>
                 <div class="controls mb-m" style="display: flex; justify-content: space-between; align-items: center;">
                     <label for="history-limit">Afficher les :</label>
                     <select id="history-limit" style="width: auto;">
                         <option value="10">10 derni√®res</option>
                         <option value="30" selected>30 derni√®res</option>
                         <option value="100">100 derni√®res</option>
                         <option value="all">Toutes</option>
                     </select>
                 </div>
                <p id="history-loading" class="text-center italic">Chargement de l'historique...</p>
                <ul>
                    <!-- Les entr√©es du journal seront ajout√©es ici -->
                </ul>
            </div>

             <div id="tracking-chart-container">
                <h3>Graphique d'√âvolution de l'Intensit√©</h3>
                <div class="controls mb-m" style="display: flex; justify-content: space-between; align-items: center;">
                     <label for="chart-limit">P√©riode :</label>
                     <select id="chart-limit" style="width: auto;">
                         <option value="7">7 derniers jours</option>
                         <option value="30" selected>30 derniers jours</option>
                         <option value="90">90 derniers jours</option>
                         <option value="all">Tout l'historique</option>
                     </select>
                 </div>
                 <div id="tracking-chart">
                    <!-- Le SVG du graphique sera inject√© ici -->
                 </div>
                 <div id="chart-no-data" class="chart-no-data hidden">Pas assez de donn√©es pour afficher le graphique.</div>
            </div>

             <div class="mt-l text-center">
                 <button id="export-data-btn" class="button-secondary mr-m">Exporter les donn√©es (JSON)</button>
                 <button id="export-csv-btn" class="button-secondary">Exporter les donn√©es (CSV)</button>
                 <button id="clear-data-btn" class="button-danger mt-m">Supprimer TOUTES les donn√©es</button>
             </div>
        </section>
    </template>

    <template id="template-resources">
        <section class="content-section">
            <h2>Ressources √âducatives</h2>
            <p>Mieux comprendre les acouph√®nes et les approches de gestion est une √©tape importante.</p>
             <div class="alert alert-warning mt-m mb-l">
                 <strong>Rappel :</strong> Les informations fournies ici sont √† but √©ducatif et ne constituent pas un avis m√©dical. Consultez un professionnel de la sant√© pour toute question relative √† votre sant√©.
             </div>

            <article class="mb-l">
                <h3>Qu'est-ce que l'Acouph√®ne ?</h3>
                <p>L'acouph√®ne (ou tinnitus) est la perception d'un son (sifflement, bourdonnement, gr√©sillement, pulsation...) en l'absence de toute source sonore externe correspondante. Ce n'est pas une maladie en soi, mais un sympt√¥me dont les causes peuvent √™tre multiples :</p>
                <ul>
                    <li>Exposition √† des bruits forts (ponctuelle ou r√©p√©t√©e).</li>
                    <li>Perte auditive li√©e √† l'√¢ge (presbyacousie).</li>
                    <li>Infections de l'oreille, bouchon de c√©rumen.</li>
                    <li>Maladies (M√©ni√®re, otoscl√©rose...).</li>
                    <li>Traumatismes cr√¢niens ou cervicaux.</li>
                    <li>Certains m√©dicaments (ototoxiques).</li>
                    <li>Stress, anxi√©t√©, fatigue.</li>
                    <li>Probl√®mes vasculaires ou neurologiques (plus rares).</li>
                </ul>
                <p>Il est crucial de consulter un m√©decin ou un ORL pour d√©terminer la cause potentielle et √©carter toute pathologie sous-jacente n√©cessitant un traitement sp√©cifique.</p>
            </article>

            <article class="mb-l">
                <h3>L'Auto-Hypnose pour la Gestion des Acouph√®nes</h3>
                <p>L'auto-hypnose est une technique qui permet d'atteindre volontairement un √©tat de conscience modifi√©, caract√©ris√© par une relaxation profonde et une concentration focalis√©e. Dans le contexte des acouph√®nes, elle ne vise pas √† "supprimer" le son, mais plut√¥t √† :</p>
                <ul>
                    <li><strong>R√©duire le Stress et l'Anxi√©t√© :</strong> Le stress est un facteur majeur d'aggravation per√ßue des acouph√®nes. L'hypnose aide √† activer la r√©ponse de relaxation du corps.</li>
                    <li><strong>Modifier la Perception :</strong> Apprendre √† percevoir l'acouph√®ne comme un son neutre, moins intrusif, moins charg√© √©motionnellement.</li>
                    <li><strong>D√©tourner l'Attention :</strong> Entra√Æner le cerveau √† se focaliser sur d'autres sensations, pens√©es ou sons agr√©ables, diminuant ainsi l'attention port√©e √† l'acouph√®ne.</li>
                    <li><strong>Am√©liorer le Sommeil :</strong> La relaxation induite peut faciliter l'endormissement malgr√© les acouph√®nes.</li>
                    <li><strong>Reprendre le Contr√¥le :</strong> Sentir que l'on dispose d'outils pour g√©rer l'impact de l'acouph√®ne peut r√©duire le sentiment d'impuissance.</li>
                </ul>
                <p>La r√©gularit√© de la pratique est la cl√©. Les sessions propos√©es dans cette application sont progressives pour vous guider.</p>
            </article>

             <article class="mb-l">
                <h3>Th√©rapie par le Son (Sound Therapy)</h3>
                <p>L'utilisation de sons externes (bruit blanc, rose, brun, sons de la nature, musique) est une approche courante. L'objectif peut √™tre :</p>
                <ul>
                    <li><strong>Masquage :</strong> Utiliser un son externe pour couvrir partiellement ou totalement l'acouph√®ne.</li>
                    <li><strong>Distraction :</strong> Fournir un autre son sur lequel se concentrer.</li>
                    <li><strong>Habituation (TRT - Tinnitus Retraining Therapy) :</strong> Utiliser un bruit neutre (souvent du bruit blanc ou rose) √† un faible volume, juste en dessous ou au niveau de l'acouph√®ne, pour aider le cerveau √† "s'habituer" √† l'acouph√®ne et √† le consid√©rer comme un son non pertinent. Cela demande du temps et souvent l'accompagnement d'un professionnel.</li>
                </ul>
                 <p>Le g√©n√©rateur de sons de cette application vous permet d'exp√©rimenter avec diff√©rents bruits.</p>
             </article>

            <article>
                <h3>Conseils Compl√©mentaires de Gestion</h3>
                <ul>
                    <li><strong>Prot√©gez votre audition :</strong> √âvitez l'exposition aux bruits forts sans protection (bouchons d'oreilles, casque anti-bruit).</li>
                    <li><strong>G√©rez votre stress :</strong> Int√©grez des activit√©s relaxantes dans votre quotidien (m√©ditation, yoga, marche dans la nature, hobbies...).</li>
                    <li><strong>Soignez votre sommeil :</strong> Couchez-vous et levez-vous √† heures r√©guli√®res, cr√©ez un environnement propice au sommeil (calme, sombre, frais). Un l√©ger bruit de fond peut aider.</li>
                    <li><strong>Activit√© physique :</strong> L'exercice r√©gulier aide √† r√©duire le stress et am√©liore la circulation sanguine.</li>
                    <li><strong>Alimentation :</strong> Bien qu'il n'y ait pas de r√©gime "anti-acouph√®nes" universel, une alimentation √©quilibr√©e est b√©n√©fique. Certaines personnes notent une influence de la caf√©ine, de l'alcool, du sel ou de certains additifs. Tenez un journal si vous suspectez un lien.</li>
                    <li><strong>√âvitez le silence complet :</strong> Le silence peut rendre l'acouph√®ne plus perceptible. Un fond sonore l√©ger (radio douce, fontaine d'int√©rieur, application de sons) peut √™tre utile, surtout la nuit.</li>
                     <li><strong>Restez inform√© mais pas obs√©d√© :</strong> Comprendre l'acouph√®ne est utile, mais passer des heures √† chercher des informations en ligne peut augmenter l'anxi√©t√©.</li>
                     <li><strong>Cherchez du soutien :</strong> Parlez-en √† vos proches, ou rejoignez des groupes de soutien (associations de patients comme France Acouph√®nes).</li>
                </ul>
            </article>

             <article class="mt-l">
                 <h3>FAQ (Foire Aux Questions)</h3>
                 <p><strong>Q: Cette application peut-elle gu√©rir mes acouph√®nes ?</strong><br> R: Non. Acouph√®nes Zen est con√ßu comme un outil pour vous aider √† g√©rer les sympt√¥mes et l'impact des acouph√®nes sur votre vie quotidienne. Il ne s'agit pas d'un traitement curatif. La gu√©rison d√©pend de la cause sous-jacente, qui doit √™tre √©valu√©e par un professionnel.</p>
                 <p class="mt-m"><strong>Q: L'auto-hypnose est-elle s√ªre ?</strong><br> R: Oui, l'auto-hypnose est g√©n√©ralement consid√©r√©e comme une technique s√ªre lorsqu'elle est utilis√©e pour la relaxation et la gestion du stress. Vous restez conscient et en contr√¥le. N'utilisez pas l'application en conduisant ou en effectuant des t√¢ches n√©cessitant votre pleine attention.</p>
                 <p class="mt-m"><strong>Q: Quel bruit (blanc, rose, brun) est le meilleur ?</strong><br> R: Il n'y a pas de "meilleur" bruit universel. Cela d√©pend des pr√©f√©rences personnelles et des caract√©ristiques de votre acouph√®ne.
                    <ul>
                        <li>Le <strong>bruit blanc</strong> contient toutes les fr√©quences √† √©gale intensit√©, il peut √™tre per√ßu comme plus "sifflant".</li>
                        <li>Le <strong>bruit rose</strong> a plus d'√©nergie dans les basses fr√©quences (son plus grave, comme une cascade ou une pluie forte), souvent per√ßu comme plus doux.</li>
                        <li>Le <strong>bruit brun</strong> a encore plus d'√©nergie dans les basses fr√©quences (son tr√®s grave, comme un grondement lointain ou un torrent), per√ßu comme le plus "profond".</li>
                    </ul>
                    Exp√©rimentez pour voir ce qui vous convient le mieux.
                 </p>
                 <p class="mt-m"><strong>Q: Mes donn√©es sont-elles s√©curis√©es ?</strong><br> R: Toutes les donn√©es que vous entrez (√©valuation, journal) sont stock√©es <strong>exclusivement</strong> dans le stockage local de votre navigateur sur votre appareil. Elles ne sont jamais envoy√©es √† un serveur externe. Vous pouvez les supprimer √† tout moment via la section "Suivi".</p>
             </article>
        </section>
    </template>


    <!-- --- JavaScript Int√©gr√© --- -->
    <script>
        // Attend que le DOM soit compl√®tement charg√©
        document.addEventListener('DOMContentLoaded', () => {

            console.log("Acouph√®nes Zen App Initializing...");

            // --- MODULE: √âtat Global & Stockage Local ---
            const Store = (() => {
                const STORAGE_KEY = 'acouphenesZenData_v1'; // Versioning key
                const MAX_JOURNAL_ENTRIES = 365; // Limiter l'historique √† 1 an d'entr√©es max

                let state = {
                    userProfile: {
                        initialAssessment: null,
                        preferences: {
                             theme: 'light'
                        }
                    },
                    sessions: [], // { timestamp: ISOString, sessionKey: string, duration: number, completed: boolean }
                    journal: [],  // { date: ISOString, intensity: number, notes: string }
                    lastActive: null
                };

                function load() {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        try {
                            const parsedData = JSON.parse(storedData);
                            // Fusionner pour pr√©server la structure par d√©faut si des cl√©s manquent
                            state = {
                                userProfile: {
                                    initialAssessment: parsedData.userProfile?.initialAssessment || null,
                                    preferences: {
                                        theme: parsedData.userProfile?.preferences?.theme || 'light'
                                    }
                                },
                                sessions: Array.isArray(parsedData.sessions) ? parsedData.sessions : [],
                                journal: Array.isArray(parsedData.journal) ? parsedData.journal : [],
                                lastActive: parsedData.lastActive || null
                            };
                             // Trier le journal au cas o√π il ne le serait pas
                             state.journal.sort((a, b) => new Date(a.date) - new Date(b.date));
                            console.log('Donn√©es charg√©es depuis localStorage.');
                        } catch (e) {
                            console.error("Erreur lors du chargement depuis localStorage:", e);
                            // Ne pas sauvegarder ici pour ne pas √©craser des donn√©es potentiellement r√©cup√©rables
                        }
                    } else {
                         console.log('Aucune donn√©e locale trouv√©e, √©tat initial.');
                         // Pas besoin de save() ici, sera fait √† la premi√®re modification
                    }
                    applyThemePreference(); // Appliquer le th√®me charg√©
                }

                function save() {
                    state.lastActive = new Date().toISOString();
                    try {
                        // Assurer que le journal est tri√© avant sauvegarde
                        state.journal.sort((a, b) => new Date(a.date) - new Date(b.date));
                        // Limiter la taille du journal
                        if (state.journal.length > MAX_JOURNAL_ENTRIES) {
                            state.journal = state.journal.slice(state.journal.length - MAX_JOURNAL_ENTRIES);
                            console.log(`Journal limit√© aux ${MAX_JOURNAL_ENTRIES} derni√®res entr√©es.`);
                        }
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                        // console.log('Donn√©es sauvegard√©es dans localStorage.');
                    } catch (e) {
                        console.error("Erreur lors de la sauvegarde dans localStorage:", e);
                        alert("Erreur lors de la sauvegarde des donn√©es. L'espace de stockage local est peut-√™tre plein ou inaccessible.");
                    }
                }

                function getState() {
                    // Retourne une copie pour √©viter les modifications externes directes
                    return JSON.parse(JSON.stringify(state));
                }

                 function updateProfile(profileData) {
                     state.userProfile.initialAssessment = profileData;
                     save();
                 }

                 function addJournalEntry(entry) {
                     if (typeof entry.intensity === 'undefined' || entry.intensity === null) {
                        console.error("Tentative d'ajout d'entr√©e de journal sans intensit√©.");
                        return null;
                     }
                     entry.date = new Date().toISOString();
                     // Nettoyer les notes (simple trim)
                     entry.notes = (entry.notes || "").trim();
                     state.journal.push(entry);
                     save(); // Sauvegarde apr√®s ajout (qui g√®re aussi le tri et la limite)
                     return entry;
                 }

                 function getJournalEntries(limit = null) {
                    // Retourne les entr√©es tri√©es par date DESC (plus r√©cent en premier) pour affichage
                     const sortedJournal = [...state.journal].sort((a, b) => new Date(b.date) - new Date(a.date));
                     if (limit && typeof limit === 'number' && limit > 0) {
                         return sortedJournal.slice(0, limit);
                     }
                     return sortedJournal;
                 }

                function addSessionLog(logData) {
                     // logData = { sessionKey: string, duration: number, completed: boolean }
                    logData.timestamp = new Date().toISOString();
                    state.sessions.push(logData);
                    // Optionnel: limiter aussi l'historique des sessions
                    // if (state.sessions.length > MAX_SESSION_LOGS) { state.sessions.shift(); }
                    save();
                }

                 function updateThemePreference(theme) {
                     state.userProfile.preferences.theme = theme;
                     save();
                 }

                 function getThemePreference() {
                     // S'assurer qu'on retourne 'light' ou 'dark'
                     const pref = state.userProfile.preferences.theme;
                     return (pref === 'dark') ? 'dark' : 'light';
                 }

                 function clearAllData() {
                     if (confirm("ATTENTION !\n\n√ätes-vous absolument s√ªr de vouloir supprimer TOUTES vos donn√©es (√©valuation, journal, historique des sessions) ?\n\nCette action est IRR√âVERSIBLE.")) {
                        localStorage.removeItem(STORAGE_KEY);
                        // R√©initialiser l'√©tat interne
                        state = {
                            userProfile: { initialAssessment: null, preferences: { theme: getThemePreference() } }, // Conserver pref th√®me
                            sessions: [],
                            journal: [],
                            lastActive: null
                        };
                        // Pas besoin de save() ici, l'√©tat est vide
                        console.log("Toutes les donn√©es utilisateur ont √©t√© supprim√©es.");
                        // Recharger la page pour refl√©ter l'√©tat vide
                        window.location.hash = '#home';
                        window.location.reload();
                        return true;
                    }
                    return false;
                 }

                 function applyThemePreference() {
                     const theme = getThemePreference();
                     document.body.classList.toggle('dark-mode', theme === 'dark');
                     const toggleButton = document.getElementById('theme-toggle');
                     if (toggleButton) {
                        toggleButton.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                        toggleButton.title = `Passer au th√®me ${theme === 'dark' ? 'clair' : 'sombre'}`;
                     }
                 }

                 // Charger les donn√©es au d√©marrage du module Store
                 load();

                return {
                    load, // Exposer load peut √™tre utile pour un rechargement manuel? Peut-√™tre pas.
                    save, // Idem.
                    getState,
                    updateProfile,
                    addJournalEntry,
                    getJournalEntries,
                    addSessionLog, // Ajout√©
                    updateThemePreference,
                    getThemePreference,
                    applyThemePreference,
                    clearAllData
                };
            })();

            // --- MODULE: UI (Manipulation du DOM & Feedback) ---
            const UI = (() => {
                const mainContent = document.getElementById('main-content');
                const navLinks = document.querySelectorAll('#main-nav a[href^="#"]'); // Cibler liens internes

                 // Stocker les √©l√©ments fr√©quemment utilis√©s pour √©viter les recherches r√©p√©t√©es
                 const uiElements = {
                    mainContent: document.getElementById('main-content'),
                    navLinks: document.querySelectorAll('#main-nav a[href^="#"]'),
                    // ... ajouter d'autres √©l√©ments si n√©cessaire au fur et √† mesure
                 };

                function renderTemplate(templateId, context = {}) {
                    const template = document.getElementById(templateId);
                    if (!template) {
                        console.error(`Template non trouv√© : ${templateId}`);
                        uiElements.mainContent.innerHTML = `<section class="content-section"><p class="alert alert-danger">Erreur : Contenu de la page introuvable.</p></section>`;
                        setActiveNavLink(''); // Aucune nav active
                        return null;
                    }
                    try {
                        const content = template.content.cloneNode(true);
                        // Optionnel: Injecter le contexte dans le template (plus avanc√©, non impl√©ment√© ici)
                        uiElements.mainContent.innerHTML = ''; // Vider le contenu pr√©c√©dent
                        uiElements.mainContent.appendChild(content);
                        setActiveNavLink(templateId.replace('template-', ''));
                        // Faire remonter en haut de page √† chaque navigation
                        window.scrollTo(0, 0);
                        return uiElements.mainContent.firstChild; // Retourne l'√©l√©ment principal ajout√© (ex: la <section>)
                    } catch (error) {
                         console.error(`Erreur lors du rendu du template ${templateId}:`, error);
                         uiElements.mainContent.innerHTML = `<section class="content-section"><p class="alert alert-danger">Erreur lors de l'affichage de cette section.</p></section>`;
                         setActiveNavLink('');
                         return null;
                    }
                }

                function setActiveNavLink(hash) {
                     uiElements.navLinks.forEach(link => {
                         link.classList.remove('active');
                         if (link.getAttribute('href') === `#${hash}`) {
                             link.classList.add('active');
                         }
                     });
                 }

                 function displayEvaluationResult(score, message) {
                    const resultDiv = document.getElementById('evaluation-result');
                    if (resultDiv) {
                        let alertClass = 'alert-success';
                        if (score >= 25) alertClass = 'alert-danger'; // Seuil exemple pour impact √©lev√©
                        else if (score >= 15) alertClass = 'alert-warning'; // Seuil exemple pour impact mod√©r√©

                        resultDiv.innerHTML = `
                            <div class="alert ${alertClass}">
                                <strong>R√©sultat de l'√©valuation :</strong> ${escapeHtml(message)} (Score d'impact total calcul√© : ${score})
                            </div>`;
                         // Scroll vers le r√©sultat pour qu'il soit visible
                         resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                 }

                 function renderJournalEntry(entry) {
                    const historyList = document.querySelector('#tracking-history ul');
                    if (!historyList) return null;

                    const li = document.createElement('li');
                    const entryDate = new Date(entry.date);
                    // Formatage plus complet de la date/heure
                    const formattedDateTime = entryDate.toLocaleString('fr-FR', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    li.innerHTML = `
                        <strong>${formattedDateTime}</strong> - Intensit√©: <span style="font-weight: bold; color: var(--primary-color);">${entry.intensity}/10</span>
                        ${entry.notes ? `<br><em>${escapeHtml(entry.notes)}</em>` : ''}
                    `;
                    return li; // Retourner l'√©l√©ment li cr√©√©
                 }

                 function displayJournalHistory(entries) {
                    const historyList = document.querySelector('#tracking-history ul');
                    const loadingMsg = document.getElementById('history-loading');
                    if (!historyList || !loadingMsg) return;

                    historyList.innerHTML = ''; // Vider la liste actuelle
                    if (!entries || entries.length === 0) {
                        loadingMsg.textContent = "Votre journal est vide pour le moment.";
                        loadingMsg.style.display = 'block';
                    } else {
                         loadingMsg.style.display = 'none';
                         entries.forEach(entry => {
                            const li = renderJournalEntry(entry);
                            if (li) historyList.appendChild(li); // Ajouter √† la fin (car les entr√©es sont d√©j√† tri√©es DESC)
                         });
                    }
                 }

                // Fonction simple pour √©chapper le HTML et pr√©venir XSS basique
                 function escapeHtml(unsafe) {
                    if (typeof unsafe !== 'string') return unsafe;
                    return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
                 }

                 // Fonction pour afficher une notification temporaire (type: 'success', 'error', 'info')
                 function showToast(message, type = 'info', duration = 3000) {
                    const toast = document.createElement('div');
                    toast.className = `toast toast-${type}`;
                    toast.textContent = message;
                    // Styles basiques pour le toast (√† am√©liorer dans le CSS si besoin)
                    toast.style.position = 'fixed';
                    toast.style.bottom = '20px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.padding = '10px 20px';
                    toast.style.borderRadius = '5px';
                    toast.style.backgroundColor = type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db';
                    toast.style.color = 'white';
                    toast.style.zIndex = '1001';
                    toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.5s ease';

                    document.body.appendChild(toast);
                    // Fade in
                    requestAnimationFrame(() => { toast.style.opacity = '1'; });

                    // Fade out and remove
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => {
                             if (toast.parentNode) {
                                 toast.parentNode.removeChild(toast);
                             }
                        }, 500); // Attendre la fin de la transition d'opacit√©
                    }, duration);
                }


                return {
                    renderTemplate,
                    setActiveNavLink,
                    displayEvaluationResult,
                    // renderJournalEntry, // rendu interne maintenant
                    displayJournalHistory,
                    escapeHtml,
                    showToast
                };
            })();


            // --- MODULE: Audio (Web Audio API) ---
            const AudioManager = (() => {
                let audioContext;
                let masterGainNode; // Un gain principal pour tout contr√¥ler
                let currentNoiseSource = null; // Le n≈ìud source du bruit actuel
                let currentNoiseType = null;
                let noiseTimer = null; // Pour le minuteur d'arr√™t

                // Fonction pour obtenir/cr√©er/reprendre le contexte audio
                function getContext() {
                    if (!audioContext) {
                        try {
                           window.AudioContext = window.AudioContext || window.webkitAudioContext;
                           if (!window.AudioContext) {
                                throw new Error("Web Audio API non support√©e");
                           }
                           audioContext = new AudioContext();
                           masterGainNode = audioContext.createGain(); // Cr√©er le gain ma√Ætre
                           masterGainNode.connect(audioContext.destination); // Connecter √† la sortie
                           console.log("AudioContext cr√©√© et pr√™t.");
                        } catch(e) {
                           console.error("Erreur AudioContext:", e);
                           UI.showToast("Erreur: Votre navigateur ne supporte pas les fonctionnalit√©s audio n√©cessaires.", "error", 5000);
                           return null;
                        }
                    }
                    // Essayer de reprendre si suspendu (souvent n√©cessaire apr√®s chargement de page)
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().catch(err => console.error("Erreur reprise AudioContext:", err));
                    }
                    return audioContext;
                }

                 // Tenter d'initialiser le contexte d√®s la premi√®re interaction utilisateur
                 function initContextOnInteraction() {
                     const initAudio = () => {
                         const context = getContext(); // Tente de cr√©er/reprendre
                         if (context && context.state === 'running') {
                             console.log("Contexte audio activ√© par interaction.");
                             // Retirer les √©couteurs une fois activ√©
                             document.body.removeEventListener('click', initAudio, { capture: true });
                             document.body.removeEventListener('touchstart', initAudio, { capture: true });
                             document.body.removeEventListener('keydown', initAudio, { capture: true });
                         }
                     };
                     // Utiliser 'capture: true' pour intercepter l'√©v√©nement t√¥t
                     document.body.addEventListener('click', initAudio, { once: true, capture: true });
                     document.body.addEventListener('touchstart', initAudio, { once: true, capture: true });
                     document.body.addEventListener('keydown', initAudio, { once: true, capture: true });
                 }


                // G√©n√©ration de Bruit Blanc (direct)
                function createWhiteNoiseSource(context) {
                    const bufferSize = context.sampleRate * 2; // 2 secondes de buffer
                    const noiseBuffer = context.createBuffer(1, bufferSize, context.sampleRate);
                    const output = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1; // Valeurs al√©atoires entre -1 et 1
                    }
                    const source = context.createBufferSource();
                    source.buffer = noiseBuffer;
                    source.loop = true;
                    return source;
                }

                // G√©n√©ration Bruit Rose (filtrage du blanc)
                function createPinkNoiseSource(context) {
                    const whiteNoise = createWhiteNoiseSource(context);
                    // Approximation du filtre 1/f avec un filtre passe-bas
                    // Un vrai filtre rose est plus complexe, mais c'est une approximation acceptable
                    const pinkFilter = context.createBiquadFilter();
                    pinkFilter.type = 'lowpass';
                    // Fr√©quence de coupure et Q ajust√©s pour ressembler au rose
                    // Ces valeurs sont empiriques et peuvent √™tre ajust√©es
                    pinkFilter.frequency.setValueAtTime(800, context.currentTime); // Fr√©quence de coupure plus haute que pour le brun
                    pinkFilter.Q.setValueAtTime(0.707, context.currentTime); // Facteur Q standard

                    whiteNoise.connect(pinkFilter);
                    return { source: whiteNoise, outputNode: pinkFilter }; // Retourner la source et le noeud final (le filtre)
                }

                // G√©n√©ration Bruit Brun (filtrage du blanc)
                function createBrownNoiseSource(context) {
                    const whiteNoise = createWhiteNoiseSource(context);
                    // Approximation du filtre 1/f^2 (Brownien/Red)
                    const brownFilter = context.createBiquadFilter();
                    brownFilter.type = 'lowpass';
                     // Fr√©quence de coupure plus basse pour att√©nuer fortement les aigus
                    brownFilter.frequency.setValueAtTime(300, context.currentTime); // Fr√©quence de coupure basse
                    brownFilter.Q.setValueAtTime(1, context.currentTime); // Q peut √™tre ajust√©

                    whiteNoise.connect(brownFilter);
                    return { source: whiteNoise, outputNode: brownFilter };
                }


                function playNoise(type, volume, durationMinutes = 0) {
                    stopNoise(); // Arr√™te le bruit pr√©c√©dent et le minuteur
                    const context = getContext();
                    if (!context || context.state !== 'running') {
                         UI.showToast("Impossible de d√©marrer l'audio. Veuillez cliquer sur la page ou interagir.", "warning");
                         console.warn("Contexte audio non pr√™t ou suspendu.");
                         return false; // Indiquer l'√©chec
                     }

                    let noiseInfo;
                    switch (type) {
                        case 'white':
                            noiseInfo = { source: createWhiteNoiseSource(context) };
                             noiseInfo.outputNode = noiseInfo.source; // Pas de filtre interm√©diaire
                            break;
                        case 'pink':
                            noiseInfo = createPinkNoiseSource(context);
                            break;
                        case 'brown':
                            noiseInfo = createBrownNoiseSource(context);
                            break;
                        default:
                            console.error(`Type de bruit non support√©: ${type}`);
                             UI.showToast(`Type de bruit inconnu: ${type}`, "error");
                            return false;
                    }

                    currentNoiseSource = noiseInfo.source;
                    currentNoiseType = type;

                    // Connecter la sortie du bruit (directe ou filtr√©e) au gain ma√Ætre
                    noiseInfo.outputNode.connect(masterGainNode);

                    // Appliquer le volume
                    setVolume(volume);

                    currentNoiseSource.start(0);
                    console.log(`Bruit ${type} d√©marr√© (volume: ${volume.toFixed(2)})`);

                     // G√©rer le minuteur d'arr√™t
                     if (durationMinutes > 0) {
                         const durationSeconds = durationMinutes * 60;
                         console.log(`Minuteur d'arr√™t r√©gl√© sur ${durationMinutes} minutes.`);
                         noiseTimer = setTimeout(() => {
                             console.log("Minuteur d'arr√™t atteint.");
                             stopNoise();
                             UI.showToast("Le son s'est arr√™t√© (minuteur).", "info");
                             // √âmettre un √©v√©nement personnalis√© pour que l'UI puisse r√©agir
                              document.dispatchEvent(new CustomEvent('audiotimerend'));
                         }, durationSeconds * 1000);
                         // √âmettre un √©v√©nement pour l'UI (mise √† jour du statut du minuteur)
                         document.dispatchEvent(new CustomEvent('audiotimerstart', { detail: { durationMinutes } }));

                     } else {
                        document.dispatchEvent(new CustomEvent('audiotimerclear'));
                     }

                     return true; // Succ√®s
                }

                function stopNoise() {
                    if (noiseTimer) {
                        clearTimeout(noiseTimer);
                        noiseTimer = null;
                         document.dispatchEvent(new CustomEvent('audiotimerclear'));
                        console.log("Minuteur d'arr√™t annul√©.");
                    }
                    if (currentNoiseSource) {
                        try {
                            // D√©connecter d'abord pour √©viter les clics potentiels
                            currentNoiseSource.disconnect();
                             // Le filtre (outputNode) est automatiquement d√©connect√© quand sa source l'est.
                             // Pas besoin de d√©connecter masterGainNode ici, il reste pour le prochain son.
                            currentNoiseSource.stop(0);
                        } catch (e) {
                            // Ignorer les erreurs si le noeud √©tait d√©j√† arr√™t√©
                            // console.warn("Erreur lors de l'arr√™t du bruit (peut √™tre normal):", e);
                        }
                        const stoppedType = currentNoiseType;
                        currentNoiseSource = null;
                        currentNoiseType = null;
                        console.log(`Bruit ${stoppedType} arr√™t√©.`);
                        return true; // Indiquer qu'un son a √©t√© arr√™t√©
                    }
                    return false; // Indiquer qu'aucun son ne jouait
                }

                function setVolume(volume) {
                    // Assurer que le volume est entre 0 et 1
                     volume = Math.max(0, Math.min(1, volume));
                    if (masterGainNode && audioContext) {
                        // Utiliser setTargetAtTime pour une transition douce (√©vite les "clics")
                        masterGainNode.gain.setTargetAtTime(volume, audioContext.currentTime, 0.015); // 0.015 = constante de temps pour la transition
                         // console.log(`Volume ajust√© √† ${volume.toFixed(2)}`);
                    }
                }

                function isPlaying() {
                    return !!currentNoiseSource;
                }

                return {
                    initContextOnInteraction,
                    playNoise,
                    stopNoise,
                    setVolume,
                    isPlaying // Exposer l'√©tat de lecture
                };
            })();


            // --- MODULE: Routage ---
            const Router = (() => {
                let currentPageInitFunction = null; // Pour stocker la fonction d'init de la page actuelle
                let currentPageCleanupFunction = null; // Pour le nettoyage

                function handleRouteChange() {
                    const hash = window.location.hash || '#home';
                    let route = hash.substring(1);

                    // Nettoyer la page pr√©c√©dente avant de changer
                    if (typeof currentPageCleanupFunction === 'function') {
                        try {
                            currentPageCleanupFunction();
                            console.log(`Nettoyage pour la page pr√©c√©dente effectu√©.`);
                        } catch (error) {
                             console.error("Erreur lors du nettoyage de la page pr√©c√©dente:", error);
                        }
                        currentPageCleanupFunction = null; // R√©initialiser
                    }
                     currentPageInitFunction = null; // R√©initialiser aussi l'init

                     // Arr√™ter tout son lors du changement de page, sauf si explicitement g√©r√© autrement
                     // (Pour l'instant, on arr√™te toujours)
                     if (AudioManager.isPlaying()) {
                        AudioManager.stopNoise();
                        UI.showToast("Son arr√™t√© en changeant de section.", "info");
                     }

                    // Valider la route (v√©rifier si le template existe)
                    const templateId = `template-${route}`;
                    if (!document.getElementById(templateId)) {
                         console.warn(`Route invalide ou template manquant: #${route}. Redirection vers #home.`);
                         route = 'home'; // Rediriger vers home par d√©faut
                         window.location.hash = '#home'; // Mettre √† jour l'URL (ce qui ne red√©clenchera pas l'event si d√©j√† sur home)
                    }

                     console.log(`Navigation vers: ${route}`);

                    // Rendre le template correspondant
                    const renderedElement = UI.renderTemplate(`template-${route}`);

                    // Ex√©cuter le code d'initialisation sp√©cifique √† la page
                    if (renderedElement) {
                        switch (route) {
                            case 'evaluation':
                                currentPageInitFunction = initEvaluationPage;
                                currentPageCleanupFunction = cleanupEvaluationPage; // Optionnel
                                break;
                            case 'hypnose':
                                currentPageInitFunction = initHypnosePage;
                                currentPageCleanupFunction = cleanupHypnosePage;
                                break;
                            case 'sounds':
                                currentPageInitFunction = initSoundsPage;
                                currentPageCleanupFunction = cleanupSoundsPage;
                                break;
                            case 'tracking':
                                currentPageInitFunction = initTrackingPage;
                                currentPageCleanupFunction = cleanupTrackingPage; // Optionnel
                                break;
                            case 'resources':
                                currentPageInitFunction = initResourcesPage; // M√™me si vide, pour la structure
                                break;
                             case 'home':
                             default:
                                currentPageInitFunction = initHomePage; // M√™me si vide
                                break;
                        }

                        // Ex√©cuter l'initialisation de la nouvelle page
                        if (typeof currentPageInitFunction === 'function') {
                           try {
                               currentPageInitFunction();
                               console.log(`Initialisation pour la page ${route} termin√©e.`);
                           } catch(error) {
                               console.error(`Erreur lors de l'initialisation de la page ${route}:`, error);
                               UI.showToast(`Erreur chargement section ${route}.`, "error");
                           }
                        }
                    }
                }

                function init() {
                    window.addEventListener('hashchange', handleRouteChange);
                    // Initialisation de l'audio apr√®s interaction utilisateur
                    AudioManager.initContextOnInteraction();
                    // Initialisation du bouton de th√®me (peut √™tre fait une seule fois)
                    initThemeToggle();
                    // G√©rer la route initiale au chargement
                    handleRouteChange();
                }

                return { init };
            })();

            // --- Fonctions d'initialisation et de nettoyage sp√©cifiques aux pages ---

            // Page d'accueil
            function initHomePage() { /* Pourrait contenir des animations ou chargements sp√©cifiques */ }

            // Page d'√©valuation
            function initEvaluationPage() {
                const form = document.getElementById('evaluation-form');
                const resultDiv = document.getElementById('evaluation-result');
                const savedProfile = Store.getState().userProfile.initialAssessment;

                // Pr√©-remplir le formulaire si des donn√©es existent
                if (form && savedProfile) {
                    Object.keys(savedProfile).forEach(key => {
                        const input = form.elements[key];
                        if (input) {
                            if (input.type === 'radio') {
                                form.querySelectorAll(`input[name="${key}"]`).forEach(radio => {
                                    radio.checked = (radio.value === savedProfile[key]);
                                });
                            } else if (input.type === 'range') {
                                input.value = savedProfile[key];
                                if (input.nextElementSibling && input.nextElementSibling.tagName === 'OUTPUT') {
                                    input.nextElementSibling.textContent = input.value;
                                }
                            } else if (input.tagName === 'SELECT') {
                                input.value = savedProfile[key];
                            } else {
                                input.value = savedProfile[key];
                            }
                        }
                    });
                     resultDiv.innerHTML = `<div class="alert alert-info">Vos informations pr√©c√©dentes ont √©t√© charg√©es. Vous pouvez les mettre √† jour.</div>`;
                } else if (resultDiv) {
                    resultDiv.innerHTML = ''; // Nettoyer si pas de donn√©es sauv√©es
                }

                if (form) {
                    form.addEventListener('submit', handleEvaluationSubmit);
                }
            }
             function handleEvaluationSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const data = {};
                let score = 0;
                 const impactKeys = ['intensity-avg', 'impact-sleep', 'impact-concentration', 'impact-mood', 'impact-hearing'];

                formData.forEach((value, key) => {
                    data[key] = UI.escapeHtml(value.trim()); // Nettoyer et √©chapper
                    // Calcul simple du score d'impact total (sur 50 max)
                    if (impactKeys.includes(key)) {
                        score += parseInt(value, 10) || 0;
                    }
                });

                console.log('Donn√©es √©valuation soumises:', data, 'Score calcul√©:', score);
                Store.updateProfile(data);

                 let message = "√âvaluation enregistr√©e. ";
                 if (score >= 25) {
                     message += "L'impact semble significatif. Les outils de relaxation et de gestion de l'attention pourraient √™tre particuli√®rement utiles.";
                 } else if (score >= 15) {
                     message += "L'impact semble mod√©r√©. L'exploration des diff√©rentes techniques peut vous aider √† le r√©duire davantage.";
                 } else {
                     message += "L'impact semble relativement l√©ger. Continuez √† utiliser les outils qui vous aident.";
                 }

                UI.displayEvaluationResult(score, message);
                UI.showToast("√âvaluation enregistr√©e avec succ√®s!", "success");
             }
            function cleanupEvaluationPage() {
                const form = document.getElementById('evaluation-form');
                 if (form) {
                    form.removeEventListener('submit', handleEvaluationSubmit);
                }
                 console.log("Nettoyage page √âvaluation");
            }


            // Page d'Auto-Hypnose
             let hypnoTimerInterval = null;
             let hypnoSessionEndTime = 0;
             let hypnoCurrentSessionData = null;
             let hypnoNoiseType = 'none';
             let hypnoVolume = 0.05;
             let hypnoSessionCompleted = false;

             // Contenu d√©taill√© des sessions
             const sessionsData = {
                 debutant: {
                     title: "D√©butant (env. 10 min) - Relaxation et Prise de Conscience",
                     duration: 10 * 60, // secondes
                     script: [
                        { time: 0, text: "Commencez par trouver une position confortable, assise ou allong√©e, o√π vous ne serez pas d√©rang√©. Fermez doucement les yeux ou fixez un point devant vous sans effort." },
                        { time: 20, text: "Prenez maintenant trois respirations profondes et calmes. Inspirez par le nez en gonflant le ventre... et expirez lentement par la bouche, en rel√¢chant les tensions..." },
                        { time: 45, text: "R√©p√©tez encore deux fois √† votre rythme... Sentez votre corps commencer √† se d√©tendre √† chaque expiration..." },
                        { time: 75, text: "Portez maintenant votre attention sur les sensations de votre corps. Ressentez le contact de vos pieds avec le sol ou le support... le poids de votre corps..." },
                        { time: 120, text: "Scannez mentalement votre corps, des pieds √† la t√™te. Remarquez simplement les sensations, sans jugement. S'il y a des tensions, imaginez qu'elles se rel√¢chent √† chaque expiration..." },
                        { time: 180, text: "Portez maintenant votre attention sur votre respiration naturelle. Observez le va-et-vient de l'air, sans chercher √† la contr√¥ler... C'est votre point d'ancrage dans le moment pr√©sent..." },
                        { time: 240, text: "Les pens√©es peuvent venir, c'est normal. Laissez-les passer comme des nuages dans le ciel, sans vous y accrocher, et revenez doucement √† la sensation de votre respiration..." },
                        { time: 300, text: "Maintenant, portez une attention douce et curieuse aux sons autour de vous... Ceux de la pi√®ce... ceux de l'ext√©rieur... Accueillez-les sans jugement..." },
                        { time: 360, text: "Remarquez aussi la pr√©sence de votre acouph√®ne, s'il est l√†. Essayez de le percevoir comme un son parmi d'autres, sans lui donner plus d'importance. Juste une sensation sonore..." },
                        { time: 420, text: "Imaginez que vous pouvez cr√©er un espace mental autour de ce son. Il est l√†, mais il y a aussi de l'espace, du calme autour..." },
                        { time: 480, text: "Revenez √† la sensation globale de votre corps d√©tendu... Appr√©ciez ce moment de calme int√©rieur..." },
                        { time: 540, text: "Sachez que vous pouvez retrouver cet √©tat de calme quand vous le souhaitez. C'est une capacit√© en vous." },
                        { time: 570, text: "Dans quelques instants, cette session va se terminer. Commencez √† reprendre conscience de votre environnement... Bougez doucement les doigts, les orteils..." },
                        { time: 590, text: "Quand vous serez pr√™t, √† votre rythme, ouvrez les yeux en gardant avec vous cette sensation de calme. √âtirez-vous si vous le souhaitez." }
                     ]
                 },
                 intermediaire: {
                     title: "Interm√©diaire (env. 15 min) - D√©tournement de l'Attention",
                     duration: 15 * 60,
                     script: [
                        { time: 0, text: "Installez-vous confortablement, fermez les yeux. Prenez quelques respirations profondes pour signaler √† votre corps qu'il peut se d√©tendre." },
                        { time: 30, text: "Imaginez une lumi√®re douce et apaisante au sommet de votre t√™te. Sentez sa chaleur et sa d√©tente descendre lentement... sur votre front... vos yeux... vos m√¢choires qui se desserrent..." },
                        { time: 60, text: "Cette vague de d√©tente descend dans votre cou, vos √©paules... le long de vos bras jusqu'au bout de vos doigts... Sentez la lourdeur agr√©able de la relaxation..." },
                        { time: 120, text: "Elle continue dans votre poitrine, votre ventre... votre dos se rel√¢che... Sentez votre respiration devenir plus calme, plus profonde..." },
                        { time: 180, text: "La d√©tente atteint vos jambes... vos genoux... vos mollets... jusqu'√† vos pieds. Tout votre corps est maintenant agr√©ablement lourd et d√©tendu." },
                        { time: 240, text: "Maintenant, portez votre attention sur votre ou√Øe. √âcoutez les sons autour de vous... sans les analyser, juste les percevoir..." },
                        { time: 300, text: "Peut-√™tre entendez-vous votre acouph√®ne. Accueillez-le un instant, sans jugement. Puis, choisissez consciemment de porter votre attention ailleurs." },
                        { time: 360, text: "Imaginez que vous √™tes dans un endroit que vous aimez, un lieu paisible. Une plage, une for√™t, un jardin... Visualisez cet endroit avec le plus de d√©tails possible." },
                        { time: 420, text: "Quelles sont les couleurs ? Les formes ? Y a-t-il une odeur particuli√®re ? Une brise l√©g√®re sur votre peau ?" },
                        { time: 480, text: "Quels sont les sons agr√©ables de cet endroit ? Le bruit des vagues ? Le chant des oiseaux ? Le vent dans les feuilles ? Concentrez-vous sur ces sons imaginaires apaisants." },
                        { time: 540, text: "Si votre attention revient √† l'acouph√®ne, c'est normal. Remarquez-le simplement, puis redirigez doucement mais fermement votre attention vers les sons agr√©ables de votre lieu paisible." },
                        { time: 660, text: "Imaginez que vous pouvez ajuster le volume des sons. Augmentez le volume des sons agr√©ables... et diminuez mentalement le volume de l'acouph√®ne, le rendant plus lointain, moins pertinent." },
                        { time: 780, text: "Restez dans cet √©tat d'absorption agr√©able, en vous concentrant sur les sensations positives de votre lieu de calme." },
                        { time: 840, text: "Sachez que votre capacit√© √† diriger votre attention est une comp√©tence puissante que vous pouvez entra√Æner." },
                        { time: 870, text: "Pr√©parez-vous maintenant √† revenir. Ramenez progressivement votre conscience √† votre corps, √† la pi√®ce o√π vous √™tes. Prenez une respiration plus profonde." },
                        { time: 890, text: "Bougez doucement, √©tirez-vous, et ouvrez les yeux quand vous √™tes pr√™t, en emportant avec vous le calme et la capacit√© √† choisir votre focus." }
                     ]
                 },
                 avance: {
                     title: "Avanc√© (env. 20 min) - Modification de la Perception",
                     duration: 20 * 60,
                     script: [
                        { time: 0, text: "Installez-vous confortablement. Fermez les yeux et prenez quelques instants pour entrer dans un √©tat de relaxation profonde, en utilisant la technique qui vous convient le mieux (respiration, scan corporel...)." },
                        { time: 60, text: "Une fois bien d√©tendu, portez votre attention sur votre acouph√®ne. Observez-le avec une curiosit√© d√©tach√©e, comme un scientifique observe un ph√©nom√®ne." },
                        { time: 120, text: "Quelles sont ses caract√©ristiques ? Est-il aigu, grave ? Continu, pulsatile ? Est-il stable ou changeant ? Essayez de le d√©crire mentalement, sans jugement de valeur ('g√™nant', 'horrible')." },
                        { time: 180, text: "Imaginez maintenant que vous avez des 'cadrans de contr√¥le' mentaux pour ce son." },
                        { time: 240, text: "Visualisez un cadran pour le volume. Imaginez que vous tournez ce cadran tr√®s lentement vers le bas. M√™me si le son r√©el ne change pas, notez toute modification dans votre perception ou votre r√©action √©motionnelle." },
                        { time: 330, text: "Visualisez un cadran pour la 'tonalit√©' ou la 'qualit√©' du son. Imaginez que vous pouvez le rendre l√©g√®rement plus grave, ou plus doux, ou plus diffus. Jouez mentalement avec ces caract√©ristiques." },
                        { time: 420, text: "Imaginez un cadran pour la 'localisation'. Pouvez-vous mentalement d√©placer le son ? Le rendre plus externe, plus lointain ? Le laisser flotter hors de votre t√™te ?" },
                        { time: 510, text: "Visualisez un cadran pour l''√©motion' associ√©e au son. Imaginez tourner ce cadran de 'g√™ne' ou 'anxi√©t√©' vers 'neutre' ou m√™me 'acceptation'." },
                        { time: 600, text: "Maintenant, laissez les cadrans et portez votre attention sur une sensation agr√©able dans votre corps. Peut-√™tre la chaleur de vos mains, la d√©tente de vos √©paules, ou le calme de votre respiration." },
                        { time: 690, text: "Amplifiez cette sensation agr√©able. Laissez-la grandir et se diffuser dans tout votre corps, cr√©ant un sentiment g√©n√©ral de bien-√™tre." },
                        { time: 780, text: "Imaginez que ce bien-√™tre est comme une bulle protectrice autour de vous. L'acouph√®ne peut √™tre l√†, √† l'ext√©rieur ou √† l'int√©rieur de la bulle, mais il ne perturbe pas le calme √† l'int√©rieur." },
                        { time: 900, text: "L'acouph√®ne est juste un son. Il n'a que le pouvoir que vous lui donnez. Vous apprenez √† lui retirer ce pouvoir √©motionnel." },
                        { time: 1020, text: "Ancrez cette sensation de contr√¥le et de calme en vous. Prenez une profonde inspiration et expirez lentement." },
                        { time: 1140, text: "Rappelez-vous que cette capacit√© √† modifier votre perception s'affine avec la pratique r√©guli√®re." },
                        { time: 1170, text: "Commencez maintenant √† revenir progressivement √† votre √©tat de conscience habituel. Sentez l'√©nergie revenir dans votre corps. Bougez les doigts, les orteils." },
                        { time: 1190, text: "Quand vous √™tes pr√™t, ouvrez les yeux, en gardant ce sentiment de perspective et de calme int√©rieur renouvel√©." }
                     ]
                 }
             };

            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "--:--";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            function updateHypnoTimer() {
                const now = Date.now();
                const remaining = Math.max(0, (hypnoSessionEndTime - now) / 1000);
                const timerDisplay = document.querySelector('#hypnose-session .timer');
                 const textContent = document.getElementById('session-text-content');
                 const stepIndicator = document.getElementById('session-step-indicator');

                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(remaining);
                }

                if (hypnoCurrentSessionData && textContent) {
                    const elapsed = hypnoCurrentSessionData.duration - remaining;
                     // Trouver l'√©tape actuelle du script
                     const currentStepIndex = hypnoCurrentSessionData.script.slice().reverse().findIndex(step => elapsed >= step.time);
                     const currentStep = currentStepIndex !== -1 ? hypnoCurrentSessionData.script[hypnoCurrentSessionData.script.length - 1 - currentStepIndex] : null;

                     if (currentStep) {
                        // Mettre √† jour le texte seulement s'il a chang√©
                        const currentTextElement = textContent.querySelector('p');
                        if (!currentTextElement || currentTextElement.textContent !== currentStep.text) {
                             textContent.innerHTML = `<p>${UI.escapeHtml(currentStep.text)}</p>`;
                             // Faire d√©filer vers le bas si n√©cessaire
                             textContent.scrollTop = textContent.scrollHeight;
                        }
                         // Mettre √† jour l'indicateur d'√©tape
                         if (stepIndicator) {
                             const totalSteps = hypnoCurrentSessionData.script.length;
                             const currentStepNumber = hypnoCurrentSessionData.script.length - currentStepIndex;
                             stepIndicator.textContent = `√âtape ${currentStepNumber} / ${totalSteps}`;
                         }

                     }
                }

                if (remaining === 0) {
                    hypnoSessionCompleted = true;
                    stopHypnoSession();
                }
            }

            function startHypnoSession(sessionKey) {
                 hypnoCurrentSessionData = sessionsData[sessionKey];
                 if (!hypnoCurrentSessionData) {
                     console.error("Donn√©es de session introuvables:", sessionKey);
                     UI.showToast("Erreur : Impossible de charger la session.", "error");
                     return;
                 }

                const menu = document.getElementById('hypnose-menu');
                const sessionView = document.getElementById('hypnose-session');
                const startBtn = document.getElementById('start-session-btn');
                const stopBtn = document.getElementById('stop-session-btn');
                const timerDisplay = sessionView.querySelector('.timer');
                const sessionTextContent = document.getElementById('session-text-content');
                const stepIndicator = document.getElementById('session-step-indicator');


                 // R√©cup√©rer les options choisies
                 hypnoNoiseType = document.getElementById('hypno-noise').value;
                 hypnoVolume = parseFloat(document.getElementById('hypno-volume').value);

                 hypnoSessionCompleted = false; // R√©initialiser l'√©tat de compl√©tion
                 sessionTextContent.innerHTML = `<p>${UI.escapeHtml(hypnoCurrentSessionData.script[0]?.text || 'Pr√©paration...')}</p>`;
                 stepIndicator.textContent = `√âtape 1 / ${hypnoCurrentSessionData.script.length}`;
                 timerDisplay.textContent = formatTime(hypnoCurrentSessionData.duration);


                 // UI updates
                 menu.classList.add('hidden');
                 sessionView.classList.remove('hidden');
                 startBtn.classList.add('hidden');
                 stopBtn.classList.remove('hidden');
                 // D√©sactiver les contr√¥les pendant la session
                 document.getElementById('hypno-noise').disabled = true;
                 document.getElementById('hypno-volume').disabled = true;


                 // D√©marrer le bruit de fond si s√©lectionn√©
                 if (hypnoNoiseType !== 'none' && hypnoVolume > 0) {
                     AudioManager.playNoise(hypnoNoiseType, hypnoVolume);
                 } else {
                     AudioManager.stopNoise(); // Assurer qu'aucun bruit ne joue
                 }

                 // D√©marrer le minuteur
                 hypnoSessionEndTime = Date.now() + hypnoCurrentSessionData.duration * 1000;
                 updateHypnoTimer(); // Premier affichage
                 hypnoTimerInterval = setInterval(updateHypnoTimer, 1000);

                 console.log(`Session d'hypnose d√©marr√©e: ${sessionKey}`);
                 UI.showToast(`Session "${hypnoCurrentSessionData.title}" d√©marr√©e.`, "info");
             }

             function stopHypnoSession() {
                 const sessionEndedNaturally = hypnoSessionCompleted;

                 clearInterval(hypnoTimerInterval);
                 hypnoTimerInterval = null;
                 AudioManager.stopNoise(); // Arr√™ter le bruit de fond

                 // Logguer la session
                 if (hypnoCurrentSessionData) {
                    Store.addSessionLog({
                        sessionKey: Object.keys(sessionsData).find(key => sessionsData[key] === hypnoCurrentSessionData), // Retrouver la cl√©
                        duration: hypnoCurrentSessionData.duration,
                        completed: sessionEndedNaturally
                    });
                    console.log(`Session ${sessionEndedNaturally ? 'termin√©e' : 'arr√™t√©e'} : ${hypnoCurrentSessionData.title}`);
                 }

                 // UI Reset
                 const menu = document.getElementById('hypnose-menu');
                 const sessionView = document.getElementById('hypnose-session');
                 const startBtn = document.getElementById('start-session-btn');
                 const stopBtn = document.getElementById('stop-session-btn');
                 const noiseSelect = document.getElementById('hypno-noise');
                 const volumeSlider = document.getElementById('hypno-volume');

                 if (sessionView) sessionView.classList.add('hidden');
                 if (menu) menu.classList.remove('hidden');
                 if (stopBtn) stopBtn.classList.add('hidden');
                 if (startBtn) {
                    startBtn.classList.remove('hidden');
                    startBtn.textContent = "S√©lectionnez une session";
                    startBtn.disabled = true; // Rendre inactif jusqu'√† nouvelle s√©lection
                    startBtn.onclick = null; // D√©tacher l'ancien handler
                 }
                  if (noiseSelect) noiseSelect.disabled = false;
                  if (volumeSlider) volumeSlider.disabled = false;


                 if (sessionEndedNaturally) {
                     UI.showToast("Session termin√©e avec succ√®s !", "success");
                 } else {
                     UI.showToast("Session arr√™t√©e.", "warning");
                 }

                 hypnoCurrentSessionData = null; // Nettoyer
                 hypnoSessionCompleted = false;
             }

            function initHypnosePage() {
                 const menu = document.getElementById('hypnose-menu');
                 const sessionView = document.getElementById('hypnose-session');
                 const startBtn = document.getElementById('start-session-btn');
                 const stopBtn = document.getElementById('stop-session-btn');
                 const sessionTitle = document.getElementById('session-title');
                 const timerDisplay = sessionView?.querySelector('.timer');
                 const noiseSelect = document.getElementById('hypno-noise');
                 const volumeSlider = document.getElementById('hypno-volume');

                 // Assurer l'√©tat initial correct de l'UI
                 if (menu) menu.classList.remove('hidden');
                 if (sessionView) sessionView.classList.add('hidden');
                 if (startBtn) {
                     startBtn.textContent = "S√©lectionnez une session";
                     startBtn.disabled = true;
                     startBtn.classList.remove('hidden');
                 }
                 if (stopBtn) stopBtn.classList.add('hidden');
                  if (noiseSelect) noiseSelect.disabled = false;
                  if (volumeSlider) volumeSlider.disabled = false;

                 // Attacher les listeners
                 if (menu) menu.addEventListener('click', handleHypnoMenuClick);
                 if (stopBtn) stopBtn.addEventListener('click', stopHypnoSession);
                 if (volumeSlider) volumeSlider.addEventListener('input', handleHypnoVolumeChange);
                 // Note: Le changement de type de bruit n'est pas permis pendant la session

                 // Pr√©-remplir le volume si une pr√©f√©rence existe (non impl√©ment√©, mais pourrait l'√™tre)
                 // volumeSlider.value = Store.getState().userProfile.preferences.hypnoVolume || 0.05;
             }
             function handleHypnoMenuClick(e) {
                 if (e.target.tagName === 'BUTTON' && e.target.dataset.session) {
                     const sessionKey = e.target.dataset.session;
                     const sessionData = sessionsData[sessionKey];
                     if (!sessionData) return;

                     const startBtn = document.getElementById('start-session-btn');
                     const sessionTitle = document.getElementById('session-title');
                     const sessionView = document.getElementById('hypnose-session');
                     const timerDisplay = sessionView?.querySelector('.timer');
                     const sessionTextContent = document.getElementById('session-text-content');
                     const stepIndicator = document.getElementById('session-step-indicator');


                     // Pr√©parer la vue de session sans la d√©marrer
                     if (sessionTitle) sessionTitle.textContent = sessionData.title + " (Pr√™t)";
                     if (timerDisplay) timerDisplay.textContent = formatTime(sessionData.duration);
                     if (sessionTextContent) sessionTextContent.innerHTML = `<p>Pr√©parez-vous. Cliquez sur "D√©marrer" quand vous √™tes pr√™t.</p>`;
                     if (stepIndicator) stepIndicator.textContent = `Dur√©e: ${Math.round(sessionData.duration / 60)} min`;


                     if (startBtn) {
                         startBtn.textContent = `D√©marrer la session`;
                         // Attacher le bon handler au bouton D√©marrer
                         startBtn.onclick = () => startHypnoSession(sessionKey);
                         startBtn.disabled = false; // Activer le bouton D√©marrer
                     }
                      if (sessionView) sessionView.classList.remove('hidden'); // Afficher la section session
                      // S'assurer que le bouton stop est cach√©
                     document.getElementById('stop-session-btn')?.classList.add('hidden');
                      // Remettre les contr√¥les √©ditables
                     document.getElementById('hypno-noise').disabled = false;
                     document.getElementById('hypno-volume').disabled = false;


                      // Scroll vers la section session pour la rendre visible
                      sessionView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 }
             }
             function handleHypnoVolumeChange(e) {
                 // Met √† jour la variable globale, sera utilis√©e au d√©marrage de la session
                 hypnoVolume = parseFloat(e.target.value);
                 // Optionnel: Mettre √† jour le volume si un bruit joue DEJA (improbable ici, mais bon)
                 // if (AudioManager.isPlaying() && hypnoTimerInterval) { // Seulement si session en cours
                 //    AudioManager.setVolume(hypnoVolume);
                 // }
             }
            function cleanupHypnosePage() {
                // Arr√™ter la session si elle est en cours en quittant la page
                 if (hypnoTimerInterval) {
                    stopHypnoSession();
                    console.warn("Session d'hypnose arr√™t√©e car l'utilisateur a quitt√© la section.");
                 }
                 // D√©tacher les listeners pour √©viter les fuites m√©moire
                 const menu = document.getElementById('hypnose-menu');
                 const stopBtn = document.getElementById('stop-session-btn');
                 const volumeSlider = document.getElementById('hypno-volume');
                 const startBtn = document.getElementById('start-session-btn');

                 if (menu) menu.removeEventListener('click', handleHypnoMenuClick);
                 if (stopBtn) stopBtn.removeEventListener('click', stopHypnoSession);
                 if (volumeSlider) volumeSlider.removeEventListener('input', handleHypnoVolumeChange);
                  if (startBtn) startBtn.onclick = null; // Important car attach√© dynamiquement

                 console.log("Nettoyage page Hypnose");
            }


            // Page G√©n√©rateur de Sons
             let soundTimerInterval = null; // Pour l'affichage du minuteur
             let soundTimerEndTime = 0;

            function updateSoundTimerDisplay() {
                 const statusSpan = document.getElementById('sound-timer-status');
                 if (!statusSpan || !AudioManager.isPlaying() || !noiseTimer) { // noiseTimer vient de AudioManager
                     if (statusSpan) statusSpan.textContent = '';
                     clearInterval(soundTimerInterval);
                     soundTimerInterval = null;
                     return;
                 }

                 const now = Date.now();
                 const remainingSeconds = Math.max(0, Math.round((soundTimerEndTime - now) / 1000));

                 if (remainingSeconds > 0) {
                     statusSpan.textContent = `Arr√™t dans: ${formatTime(remainingSeconds)}`;
                 } else {
                     statusSpan.textContent = ''; // Timer termin√©
                     clearInterval(soundTimerInterval);
                     soundTimerInterval = null;
                 }
             }

            function initSoundsPage() {
                const playBtn = document.getElementById('play-sound-btn');
                const stopBtn = document.getElementById('stop-sound-btn');
                const volumeSlider = document.getElementById('sound-volume');
                const volumeOutput = volumeSlider?.nextElementSibling;
                const typeSelect = document.getElementById('sound-type-select');
                const timerInput = document.getElementById('sound-timer');

                function updateVolumeOutputDisplay() {
                    if (volumeSlider && volumeOutput) {
                         volumeOutput.textContent = parseFloat(volumeSlider.value).toFixed(2);
                    }
                 }

                // Attacher les listeners
                playBtn?.addEventListener('click', handlePlaySound);
                stopBtn?.addEventListener('click', handleStopSound);
                volumeSlider?.addEventListener('input', handleSoundVolumeInput);
                 // Mettre √† jour le volume imm√©diatement si le son joue d√©j√†
                 volumeSlider?.addEventListener('change', handleSoundVolumeChange);

                // Initialiser l'affichage
                updateVolumeOutputDisplay();
                stopBtn?.classList.add('hidden');
                playBtn?.classList.remove('hidden');

                // Listener pour mettre √† jour l'UI quand le minuteur change (via √©v√©nement personnalis√©)
                 document.addEventListener('audiotimerstart', handleAudioTimerStart);
                 document.addEventListener('audiotimerend', handleAudioTimerEnd);
                 document.addEventListener('audiotimerclear', handleAudioTimerClear);

            }
            function handlePlaySound() {
                const type = document.getElementById('sound-type-select').value;
                const volume = parseFloat(document.getElementById('sound-volume').value);
                const durationMinutes = parseInt(document.getElementById('sound-timer').value, 10) || 0;

                 const success = AudioManager.playNoise(type, volume, durationMinutes);

                 if (success) {
                     document.getElementById('play-sound-btn')?.classList.add('hidden');
                     document.getElementById('stop-sound-btn')?.classList.remove('hidden');
                     // D√©sactiver les contr√¥les pendant la lecture pour simplicit√©
                     document.getElementById('sound-type-select').disabled = true;
                     document.getElementById('sound-timer').disabled = true;
                 }
             }
             function handleStopSound() {
                 const stopped = AudioManager.stopNoise();
                 if (stopped) {
                     document.getElementById('play-sound-btn')?.classList.remove('hidden');
                     document.getElementById('stop-sound-btn')?.classList.add('hidden');
                     // R√©activer les contr√¥les
                      document.getElementById('sound-type-select').disabled = false;
                      document.getElementById('sound-timer').disabled = false;
                      document.getElementById('sound-timer-status').textContent = ''; // Nettoyer affichage minuteur
                      if (soundTimerInterval) clearInterval(soundTimerInterval);
                      soundTimerInterval = null;
                 }
             }
             function handleSoundVolumeInput(e) {
                 // Met √† jour l'affichage pendant le glissement
                 const volumeOutput = e.target.nextElementSibling;
                 if (volumeOutput) volumeOutput.textContent = parseFloat(e.target.value).toFixed(2);
                 // Appliquer le volume en temps r√©el (si le son joue)
                 if (AudioManager.isPlaying()) {
                     AudioManager.setVolume(parseFloat(e.target.value));
                 }
             }
             function handleSoundVolumeChange(e) {
                 // S'assure que le volume est bien appliqu√© √† la fin du glissement
                 AudioManager.setVolume(parseFloat(e.target.value));
             }
             // G√©rer l'affichage du minuteur
             function handleAudioTimerStart(e) {
                const durationMinutes = e.detail.durationMinutes;
                soundTimerEndTime = Date.now() + durationMinutes * 60 * 1000;
                 if (soundTimerInterval) clearInterval(soundTimerInterval); // Nettoyer ancien intervalle
                 updateSoundTimerDisplay(); // Affichage imm√©diat
                 soundTimerInterval = setInterval(updateSoundTimerDisplay, 1000);
             }
             function handleAudioTimerEnd() {
                 // Appel√© quand le minuteur se termine via AudioManager
                 handleStopSound(); // Met √† jour l'UI comme si on avait cliqu√© Stop
             }
              function handleAudioTimerClear() {
                 // Appel√© si le minuteur est annul√© (ex: stop manuel)
                 if (soundTimerInterval) clearInterval(soundTimerInterval);
                 soundTimerInterval = null;
                 const statusSpan = document.getElementById('sound-timer-status');
                 if (statusSpan) statusSpan.textContent = '';
             }

            function cleanupSoundsPage() {
                 // Arr√™ter le son si on quitte la page
                 if (AudioManager.isPlaying()) {
                    handleStopSound(); // Utilise la fonction qui nettoie aussi l'UI et le timer
                    console.log("Son arr√™t√© en quittant la section Sons.");
                 }
                 // D√©tacher les listeners
                 const playBtn = document.getElementById('play-sound-btn');
                 const stopBtn = document.getElementById('stop-sound-btn');
                 const volumeSlider = document.getElementById('sound-volume');
                 playBtn?.removeEventListener('click', handlePlaySound);
                 stopBtn?.removeEventListener('click', handleStopSound);
                 volumeSlider?.removeEventListener('input', handleSoundVolumeInput);
                 volumeSlider?.removeEventListener('change', handleSoundVolumeChange);

                 document.removeEventListener('audiotimerstart', handleAudioTimerStart);
                 document.removeEventListener('audiotimerend', handleAudioTimerEnd);
                 document.removeEventListener('audiotimerclear', handleAudioTimerClear);

                 if (soundTimerInterval) clearInterval(soundTimerInterval); // Nettoyer l'intervalle d'affichage
                 soundTimerInterval = null;

                 console.log("Nettoyage page Sons");
            }

            // Page Suivi
             let currentChart = null; // Garder une r√©f√©rence au graphique pour le redessiner

            function initTrackingPage() {
                 const form = document.getElementById('tracking-form');
                 const clearDataBtn = document.getElementById('clear-data-btn');
                 const exportJsonBtn = document.getElementById('export-data-btn');
                 const exportCsvBtn = document.getElementById('export-csv-btn');
                 const historyLimitSelect = document.getElementById('history-limit');
                 const chartLimitSelect = document.getElementById('chart-limit');

                 // Attacher listeners
                 form?.addEventListener('submit', handleTrackingSubmit);
                 clearDataBtn?.addEventListener('click', handleClearData);
                 exportJsonBtn?.addEventListener('click', handleExportJson);
                 exportCsvBtn?.addEventListener('click', handleExportCsv);
                 historyLimitSelect?.addEventListener('change', updateTrackingDisplay);
                 chartLimitSelect?.addEventListener('change', updateTrackingDisplay);


                 // Affichage initial
                 updateTrackingDisplay();
            }

             function updateTrackingDisplay() {
                 const historyLimit = document.getElementById('history-limit')?.value || '30';
                 const chartLimit = document.getElementById('chart-limit')?.value || '30';

                 let limitHistoryNum = historyLimit === 'all' ? null : parseInt(historyLimit, 10);
                 let limitChartDays = chartLimit === 'all' ? null : parseInt(chartLimit, 10);


                 // Charger et afficher l'historique (limit√©)
                 const entries = Store.getJournalEntries(limitHistoryNum); // getJournalEntries retourne d√©j√† tri√© DESC
                 UI.displayJournalHistory(entries);

                 // Charger les donn√©es pour le graphique (non tri√©es initialement)
                 const allJournalData = Store.getState().journal; // On a besoin de toutes les donn√©es tri√©es ASC pour le graph
                 drawIntensityChart(allJournalData, limitChartDays);
             }


             function handleTrackingSubmit(e) {
                 e.preventDefault();
                 const form = e.target;
                 const formData = new FormData(form);
                 const newEntry = {
                     intensity: formData.get('intensity'),
                     notes: formData.get('notes')
                 };
                 const savedEntry = Store.addJournalEntry(newEntry);
                 if (savedEntry) {
                     form.reset();
                     // R√©initialiser l'affichage du range
                     const intensityRange = document.getElementById('tracking-intensity');
                     if(intensityRange && intensityRange.nextElementSibling) {
                        intensityRange.nextElementSibling.textContent = intensityRange.defaultValue; // Remettre √† la valeur par d√©faut (5)
                     }
                     UI.showToast('Entr√©e ajout√©e au journal.', 'success');
                     // Mettre √† jour l'affichage (historique et graphique)
                     updateTrackingDisplay();
                 } else {
                     UI.showToast("Erreur lors de l'ajout de l'entr√©e.", 'error');
                 }
             }
             function handleClearData() {
                 Store.clearAllData();
                 // La page sera recharg√©e par Store.clearAllData en cas de succ√®s
             }
             function handleExportJson() {
                 try {
                     const data = Store.getState();
                     // Optionnel: exclure les pr√©f√©rences si non pertinent pour l'export
                     // const dataToExport = { userProfile: {initialAssessment: data.userProfile.initialAssessment}, sessions: data.sessions, journal: data.journal };
                     const dataStr = JSON.stringify(data, null, 2);
                     const blob = new Blob([dataStr], { type: 'application/json' });
                     const url = URL.createObjectURL(blob);
                     const link = document.createElement('a');
                     link.href = url;
                     link.download = `acouphenes_zen_data_${new Date().toISOString().split('T')[0]}.json`;
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                     URL.revokeObjectURL(url);
                     UI.showToast("Exportation JSON termin√©e.", "success");
                 } catch (error) {
                     console.error("Erreur exportation JSON:", error);
                     UI.showToast("Erreur lors de l'exportation JSON.", "error");
                 }
             }
             function handleExportCsv() {
                try {
                    const journal = Store.getState().journal; // R√©cup√©rer le journal tri√© ASC
                    if (!journal || journal.length === 0) {
                        UI.showToast("Le journal est vide, rien √† exporter en CSV.", "warning");
                        return;
                    }

                    // Cr√©er l'en-t√™te CSV
                    const header = "DateHeureISO;Intensite;Notes\n";
                    // Convertir chaque entr√©e en ligne CSV
                    const rows = journal.map(entry => {
                        const date = entry.date;
                        const intensity = entry.intensity;
                        // √âchapper les guillemets dans les notes et entourer de guillemets si contient point-virgule ou saut de ligne
                        let notes = entry.notes || "";
                        if (notes.includes('"') || notes.includes(';') || notes.includes('\n')) {
                            notes = `"${notes.replace(/"/g, '""')}"`; // Double les guillemets internes et entoure
                        }
                        return `${date};${intensity};${notes}`;
                    });

                    const csvContent = header + rows.join("\n");
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                     const link = document.createElement('a');
                     link.href = url;
                     link.download = `acouphenes_zen_journal_${new Date().toISOString().split('T')[0]}.csv`;
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                     URL.revokeObjectURL(url);
                    UI.showToast("Exportation CSV du journal termin√©e.", "success");

                } catch (error) {
                    console.error("Erreur exportation CSV:", error);
                    UI.showToast("Erreur lors de l'exportation CSV.", "error");
                }
             }

            function drawIntensityChart(data, limitDays) {
                 const container = document.getElementById('tracking-chart');
                 const noDataMsg = document.getElementById('chart-no-data');
                 if (!container || !noDataMsg) return;

                 container.innerHTML = ''; // Clear previous chart
                 noDataMsg.classList.add('hidden');

                 // Filtrer les donn√©es par date si une limite est sp√©cifi√©e
                 let filteredData = data;
                 if (limitDays !== null && limitDays > 0) {
                     const limitDate = new Date();
                     limitDate.setDate(limitDate.getDate() - limitDays);
                     filteredData = data.filter(entry => new Date(entry.date) >= limitDate);
                 }

                 if (filteredData.length < 2) {
                     noDataMsg.classList.remove('hidden');
                     console.log("Pas assez de donn√©es pour le graphique.");
                     return;
                 }

                 // Trier les donn√©es filtr√©es par date ASC (normalement d√©j√† fait par Store, mais double check)
                 filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));


                 // --- D√©but logique de dessin SVG ---
                 const svgNS = "http://www.w3.org/2000/svg";
                 const svg = document.createElementNS(svgNS, "svg");

                 // D√©finir les dimensions et marges
                 const containerRect = container.getBoundingClientRect();
                 // Utiliser la largeur du conteneur, mais une hauteur fixe ou calcul√©e
                 const svgWidth = containerRect.width || 600;
                 const svgHeight = 250; // Hauteur fixe pour le graphique
                 const margin = { top: 20, right: 30, bottom: 40, left: 40 };
                 const width = svgWidth - margin.left - margin.right;
                 const height = svgHeight - margin.top - margin.bottom;

                 svg.setAttribute("viewBox", `0 0 ${svgWidth} ${svgHeight}`);
                 svg.setAttribute("preserveAspectRatio", "xMidYMid meet"); // Pour la responsivit√©
                 svg.style.width = "100%"; // Assurer qu'il prend la largeur
                 svg.style.height = `${svgHeight}px`; // Fixer la hauteur


                 const g = document.createElementNS(svgNS, "g");
                 g.setAttribute("transform", `translate(${margin.left},${margin.top})`);
                 svg.appendChild(g);

                 // √âchelles
                 const firstDate = new Date(filteredData[0].date);
                 const lastDate = new Date(filteredData[filteredData.length - 1].date);

                 const xScale = (date) => {
                    const timeDiff = new Date(date).getTime() - firstDate.getTime();
                    const totalTimeDiff = lastDate.getTime() - firstDate.getTime();
                    // √âviter division par z√©ro si une seule date (d√©j√† g√©r√© par filteredData.length < 2)
                     if (totalTimeDiff === 0) return 0;
                    return (timeDiff / totalTimeDiff) * width;
                 };
                 // √âchelle Y invers√©e (0 en haut en SVG) allant de 0 √† 10 (intensit√©)
                 const yScale = (intensity) => height - (intensity / 10) * height;


                 // Axes (simples lignes)
                 // Axe Y
                 const yAxis = document.createElementNS(svgNS, "line");
                 yAxis.setAttribute("x1", 0);
                 yAxis.setAttribute("y1", 0);
                 yAxis.setAttribute("x2", 0);
                 yAxis.setAttribute("y2", height);
                 yAxis.setAttribute("class", "chart-axis");
                 g.appendChild(yAxis);
                 // Labels Axe Y (0, 5, 10)
                 [0, 5, 10].forEach(val => {
                    const y = yScale(val);
                    const label = document.createElementNS(svgNS, "text");
                    label.setAttribute("x", -margin.left / 2);
                    label.setAttribute("y", y);
                    label.setAttribute("dy", "0.32em"); // Ajustement vertical
                    label.setAttribute("class", "chart-text axis-label-y");
                    label.textContent = val;
                    g.appendChild(label);
                     // Ligne de grille horizontale
                    const gridLine = document.createElementNS(svgNS, "line");
                    gridLine.setAttribute("x1", 0);
                    gridLine.setAttribute("y1", y);
                    gridLine.setAttribute("x2", width);
                    gridLine.setAttribute("y2", y);
                    gridLine.setAttribute("class", "chart-axis");
                    gridLine.style.opacity = "0.3"; // Grille plus discr√®te
                    g.appendChild(gridLine);
                 });

                 // Axe X
                 const xAxis = document.createElementNS(svgNS, "line");
                 xAxis.setAttribute("x1", 0);
                 xAxis.setAttribute("y1", height);
                 xAxis.setAttribute("x2", width);
                 xAxis.setAttribute("y2", height);
                 xAxis.setAttribute("class", "chart-axis");
                 g.appendChild(xAxis);
                 // Labels Axe X (d√©but et fin)
                 const formatDateLabel = (date) => date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit'});
                 [firstDate, lastDate].forEach((date, index) => {
                    const x = index === 0 ? 0 : width;
                    const label = document.createElementNS(svgNS, "text");
                    label.setAttribute("x", x);
                    label.setAttribute("y", height + margin.bottom / 2);
                    label.setAttribute("dy", "0.71em"); // Ajustement vertical
                    label.setAttribute("class", "chart-text axis-label-x");
                     // Ajuster l'ancre pour le dernier label
                     if (index === filteredData.length - 1) label.style.textAnchor = "end";
                     else if (index === 0) label.style.textAnchor = "start";

                    label.textContent = formatDateLabel(date);
                    g.appendChild(label);
                 });


                 // Ligne de donn√©es
                 const linePath = document.createElementNS(svgNS, "path");
                 const pathData = filteredData.map((d, i) => {
                     const x = xScale(d.date);
                     const y = yScale(d.intensity);
                     return `${i === 0 ? 'M' : 'L'} ${x.toFixed(2)} ${y.toFixed(2)}`;
                 }).join(" ");
                 linePath.setAttribute("d", pathData);
                 linePath.setAttribute("class", "chart-line");
                 g.appendChild(linePath);

                 // Points de donn√©es (avec tooltip simple)
                 filteredData.forEach(d => {
                     const x = xScale(d.date);
                     const y = yScale(d.intensity);
                     const point = document.createElementNS(svgNS, "circle");
                     point.setAttribute("cx", x);
                     point.setAttribute("cy", y);
                     point.setAttribute("r", 4); // Rayon du point
                     point.setAttribute("class", "chart-point");

                     // Tooltip SVG simple (titre)
                     const title = document.createElementNS(svgNS, "title");
                     const pointDate = new Date(d.date);
                     title.textContent = `${pointDate.toLocaleDateString('fr-FR')} ${pointDate.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})} - Intensit√©: ${d.intensity}`;
                     point.appendChild(title);

                     g.appendChild(point);
                 });


                 // Ajouter le SVG au conteneur
                 container.appendChild(svg);
                 // --- Fin logique de dessin SVG ---
             }

             function cleanupTrackingPage() {
                 const form = document.getElementById('tracking-form');
                 const clearDataBtn = document.getElementById('clear-data-btn');
                 const exportJsonBtn = document.getElementById('export-data-btn');
                 const exportCsvBtn = document.getElementById('export-csv-btn');
                 const historyLimitSelect = document.getElementById('history-limit');
                 const chartLimitSelect = document.getElementById('chart-limit');

                 form?.removeEventListener('submit', handleTrackingSubmit);
                 clearDataBtn?.removeEventListener('click', handleClearData);
                 exportJsonBtn?.removeEventListener('click', handleExportJson);
                 exportCsvBtn?.removeEventListener('click', handleExportCsv);
                 historyLimitSelect?.removeEventListener('change', updateTrackingDisplay);
                 chartLimitSelect?.removeEventListener('change', updateTrackingDisplay);

                 // Nettoyer le graphique si n√©cessaire (d√©j√† fait au d√©but de drawIntensityChart)
                 const container = document.getElementById('tracking-chart');
                 if (container) container.innerHTML = '';

                 console.log("Nettoyage page Suivi");
             }

             // Page Ressources
             function initResourcesPage() { /* Pourrait charger dynamiquement plus de contenu */ }


            // --- Initialisation G√©n√©rale ---
             function initThemeToggle() {
                const toggleButton = document.getElementById('theme-toggle');
                if (toggleButton) {
                    toggleButton.addEventListener('click', () => {
                        const currentTheme = Store.getThemePreference();
                        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        Store.updateThemePreference(newTheme);
                        Store.applyThemePreference();
                    });
                    // Appliquer le th√®me initial (d√©j√† fait dans Store.load, mais r√©assure)
                    Store.applyThemePreference();
                }
            }


            // --- D√âMARRAGE DE L'APPLICATION ---
            Router.init();
            console.log("Acouph√®nes Zen App Ready.");

        }); // Fin de DOMContentLoaded
    </script>
</body>
</html>
